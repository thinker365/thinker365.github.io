<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>杏壳儿</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.5675a7d7.css" as="style"><link rel="preload" href="/assets/js/app.dd60fddf.js" as="script"><link rel="preload" href="/assets/js/2.1d799614.js" as="script"><link rel="preload" href="/assets/js/19.0925b886.js" as="script"><link rel="prefetch" href="/assets/js/10.f42a5970.js"><link rel="prefetch" href="/assets/js/100.fd420176.js"><link rel="prefetch" href="/assets/js/101.fd3f9957.js"><link rel="prefetch" href="/assets/js/102.d3c4087c.js"><link rel="prefetch" href="/assets/js/103.5bf5f364.js"><link rel="prefetch" href="/assets/js/104.c19dc6fc.js"><link rel="prefetch" href="/assets/js/105.3644a723.js"><link rel="prefetch" href="/assets/js/106.c99225f8.js"><link rel="prefetch" href="/assets/js/107.97852924.js"><link rel="prefetch" href="/assets/js/108.212c27f0.js"><link rel="prefetch" href="/assets/js/109.d6e4c811.js"><link rel="prefetch" href="/assets/js/11.91f395ed.js"><link rel="prefetch" href="/assets/js/110.96b9b201.js"><link rel="prefetch" href="/assets/js/111.78b25fde.js"><link rel="prefetch" href="/assets/js/112.8c82f9a4.js"><link rel="prefetch" href="/assets/js/113.aae564aa.js"><link rel="prefetch" href="/assets/js/114.313f0d5b.js"><link rel="prefetch" href="/assets/js/115.844f47cf.js"><link rel="prefetch" href="/assets/js/116.4d2691a0.js"><link rel="prefetch" href="/assets/js/117.bd36d4a2.js"><link rel="prefetch" href="/assets/js/118.d205f7e7.js"><link rel="prefetch" href="/assets/js/119.ee336fe8.js"><link rel="prefetch" href="/assets/js/12.5e7abec9.js"><link rel="prefetch" href="/assets/js/120.f5ba9dbe.js"><link rel="prefetch" href="/assets/js/121.05e1c205.js"><link rel="prefetch" href="/assets/js/122.779c5f8c.js"><link rel="prefetch" href="/assets/js/123.64ad1fde.js"><link rel="prefetch" href="/assets/js/124.72120675.js"><link rel="prefetch" href="/assets/js/125.7f1e0958.js"><link rel="prefetch" href="/assets/js/126.dcd28d9f.js"><link rel="prefetch" href="/assets/js/127.428f223e.js"><link rel="prefetch" href="/assets/js/128.0ebf700a.js"><link rel="prefetch" href="/assets/js/129.3d7442ee.js"><link rel="prefetch" href="/assets/js/13.ec7d048b.js"><link rel="prefetch" href="/assets/js/130.b946546b.js"><link rel="prefetch" href="/assets/js/131.0ea40481.js"><link rel="prefetch" href="/assets/js/132.4a4437c1.js"><link rel="prefetch" href="/assets/js/133.7e17bb00.js"><link rel="prefetch" href="/assets/js/134.95928b65.js"><link rel="prefetch" href="/assets/js/135.fb730cc9.js"><link rel="prefetch" href="/assets/js/136.ce2e6b16.js"><link rel="prefetch" href="/assets/js/137.30dda982.js"><link rel="prefetch" href="/assets/js/138.9d9bd5df.js"><link rel="prefetch" href="/assets/js/139.19e62986.js"><link rel="prefetch" href="/assets/js/14.27407a31.js"><link rel="prefetch" href="/assets/js/140.425bbd4e.js"><link rel="prefetch" href="/assets/js/141.13f9ac88.js"><link rel="prefetch" href="/assets/js/142.b12b14dc.js"><link rel="prefetch" href="/assets/js/15.3653047a.js"><link rel="prefetch" href="/assets/js/16.7baae9f5.js"><link rel="prefetch" href="/assets/js/17.dcad52cb.js"><link rel="prefetch" href="/assets/js/18.bb46f976.js"><link rel="prefetch" href="/assets/js/20.e2181917.js"><link rel="prefetch" href="/assets/js/21.2e00fc64.js"><link rel="prefetch" href="/assets/js/22.60af365a.js"><link rel="prefetch" href="/assets/js/23.9a6247e9.js"><link rel="prefetch" href="/assets/js/24.533a55d3.js"><link rel="prefetch" href="/assets/js/25.0d54429f.js"><link rel="prefetch" href="/assets/js/26.f70e7a58.js"><link rel="prefetch" href="/assets/js/27.357c2f0c.js"><link rel="prefetch" href="/assets/js/28.05884156.js"><link rel="prefetch" href="/assets/js/29.b63f5d12.js"><link rel="prefetch" href="/assets/js/3.b3c0c8cc.js"><link rel="prefetch" href="/assets/js/30.c37379b8.js"><link rel="prefetch" href="/assets/js/31.e5583500.js"><link rel="prefetch" href="/assets/js/32.2f8a89ce.js"><link rel="prefetch" href="/assets/js/33.8526b5cc.js"><link rel="prefetch" href="/assets/js/34.8c476ba1.js"><link rel="prefetch" href="/assets/js/35.28a9e848.js"><link rel="prefetch" href="/assets/js/36.22caee50.js"><link rel="prefetch" href="/assets/js/37.f564431c.js"><link rel="prefetch" href="/assets/js/38.60510a45.js"><link rel="prefetch" href="/assets/js/39.b57d73b7.js"><link rel="prefetch" href="/assets/js/4.6dd544f6.js"><link rel="prefetch" href="/assets/js/40.a0f12257.js"><link rel="prefetch" href="/assets/js/41.ae21b83f.js"><link rel="prefetch" href="/assets/js/42.4a8b0eed.js"><link rel="prefetch" href="/assets/js/43.a4b1dbe5.js"><link rel="prefetch" href="/assets/js/44.7957e7b8.js"><link rel="prefetch" href="/assets/js/45.22f92df5.js"><link rel="prefetch" href="/assets/js/46.a7bd57b2.js"><link rel="prefetch" href="/assets/js/47.1076bbe9.js"><link rel="prefetch" href="/assets/js/48.10c8f82d.js"><link rel="prefetch" href="/assets/js/49.aea6f4f0.js"><link rel="prefetch" href="/assets/js/5.7fae9900.js"><link rel="prefetch" href="/assets/js/50.97341023.js"><link rel="prefetch" href="/assets/js/51.2213cc76.js"><link rel="prefetch" href="/assets/js/52.4b1c29e4.js"><link rel="prefetch" href="/assets/js/53.a6434736.js"><link rel="prefetch" href="/assets/js/54.59470ace.js"><link rel="prefetch" href="/assets/js/55.49cec6b6.js"><link rel="prefetch" href="/assets/js/56.06f2e67d.js"><link rel="prefetch" href="/assets/js/57.2e812620.js"><link rel="prefetch" href="/assets/js/58.e6ce6313.js"><link rel="prefetch" href="/assets/js/59.35026211.js"><link rel="prefetch" href="/assets/js/6.8c7a6ec4.js"><link rel="prefetch" href="/assets/js/60.cc2c97a8.js"><link rel="prefetch" href="/assets/js/61.8d91a90f.js"><link rel="prefetch" href="/assets/js/62.991f9147.js"><link rel="prefetch" href="/assets/js/63.85532e4f.js"><link rel="prefetch" href="/assets/js/64.90068745.js"><link rel="prefetch" href="/assets/js/65.ff870427.js"><link rel="prefetch" href="/assets/js/66.ba94b154.js"><link rel="prefetch" href="/assets/js/67.5158a096.js"><link rel="prefetch" href="/assets/js/68.54fe2ba5.js"><link rel="prefetch" href="/assets/js/69.bcb4c73f.js"><link rel="prefetch" href="/assets/js/7.3c7e6d86.js"><link rel="prefetch" href="/assets/js/70.00d41657.js"><link rel="prefetch" href="/assets/js/71.892ff6f5.js"><link rel="prefetch" href="/assets/js/72.2302172b.js"><link rel="prefetch" href="/assets/js/73.02125fde.js"><link rel="prefetch" href="/assets/js/74.23ba9330.js"><link rel="prefetch" href="/assets/js/75.c6915e81.js"><link rel="prefetch" href="/assets/js/76.f26b5808.js"><link rel="prefetch" href="/assets/js/77.e9b2145e.js"><link rel="prefetch" href="/assets/js/78.41764819.js"><link rel="prefetch" href="/assets/js/79.194bc603.js"><link rel="prefetch" href="/assets/js/8.1788d36a.js"><link rel="prefetch" href="/assets/js/80.4b57cedb.js"><link rel="prefetch" href="/assets/js/81.f9556a24.js"><link rel="prefetch" href="/assets/js/82.f18755ed.js"><link rel="prefetch" href="/assets/js/83.5c9f9489.js"><link rel="prefetch" href="/assets/js/84.5c47e245.js"><link rel="prefetch" href="/assets/js/85.1b40b497.js"><link rel="prefetch" href="/assets/js/86.774be43b.js"><link rel="prefetch" href="/assets/js/87.f2848ddb.js"><link rel="prefetch" href="/assets/js/88.0f0b4fab.js"><link rel="prefetch" href="/assets/js/89.2ae8eea2.js"><link rel="prefetch" href="/assets/js/9.c52fca3a.js"><link rel="prefetch" href="/assets/js/90.3e798661.js"><link rel="prefetch" href="/assets/js/91.329942cb.js"><link rel="prefetch" href="/assets/js/92.f6b412ea.js"><link rel="prefetch" href="/assets/js/93.1bad8fe5.js"><link rel="prefetch" href="/assets/js/94.8ab22d8b.js"><link rel="prefetch" href="/assets/js/95.af7ae9bb.js"><link rel="prefetch" href="/assets/js/96.b84c5880.js"><link rel="prefetch" href="/assets/js/97.8584121b.js"><link rel="prefetch" href="/assets/js/98.3d7a6b2a.js"><link rel="prefetch" href="/assets/js/99.da28339e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5675a7d7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/开心果.png" alt="杏壳儿" class="logo"> <span class="site-name can-hide">杏壳儿</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软件测试体系" class="dropdown-title"><span class="title">软件测试体系</span> <span class="arrow down"></span></button> <button type="button" aria-label="软件测试体系" class="mobile-dropdown-title"><span class="title">软件测试体系</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/qa/basics/" class="nav-link">
  测试基础
</a></li><li class="dropdown-item"><!----> <a href="/qa/automatic/" class="nav-link">
  自动测试
</a></li><li class="dropdown-item"><!----> <a href="/qa/performance/" class="nav-link">
  性能测试
</a></li><li class="dropdown-item"><!----> <a href="/qa/special/" class="nav-link">
  专项测试
</a></li><li class="dropdown-item"><!----> <a href="/qa/security/" class="nav-link">
  安全测试
</a></li><li class="dropdown-item"><!----> <a href="/qa/tool/" class="nav-link">
  测试工具
</a></li><li class="dropdown-item"><!----> <a href="/qa/framework/" class="nav-link">
  测试框架
</a></li><li class="dropdown-item"><!----> <a href="/qa/view/" class="nav-link">
  测试思考
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/basic/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/basic/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/basic/algorithms/" class="nav-link">
  数据结构与算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端游乐场</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端游乐场</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  VUE
</a></li><li class="dropdown-item"><!----> <a href="/frontend/css/" class="nav-link">
  CSS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端训练场" class="dropdown-title"><span class="title">后端训练场</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端训练场" class="mobile-dropdown-title"><span class="title">后端训练场</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          编程语言
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/python/" class="nav-link">
  Python
</a></li><li class="dropdown-subitem"><a href="/backend/java/" class="nav-link">
  Java
</a></li></ul></li><li class="dropdown-item"><h4>
          WEB框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/django/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Django
</a></li><li class="dropdown-subitem"><a href="/backend/drf/" class="nav-link">
  Django REST Framework
</a></li></ul></li><li class="dropdown-item"><h4>
          中间件
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/celery/" class="nav-link">
  Celery
</a></li></ul></li><li class="dropdown-item"><h4>
          数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-subitem"><a href="/backend/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-subitem"><a href="/backend/mongodb/" class="nav-link">
  Mongodb
</a></li><li class="dropdown-subitem"><a href="/backend/elasticsearch/" class="nav-link">
  Elasticsearch
</a></li></ul></li><li class="dropdown-item"><h4>
          部署
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/uwsgi/" class="nav-link">
  Uwsgi
</a></li><li class="dropdown-subitem"><a href="/backend/gunicorn/" class="nav-link">
  Gunicorn
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="DevOps" class="dropdown-title"><span class="title">DevOps</span> <span class="arrow down"></span></button> <button type="button" aria-label="DevOps" class="mobile-dropdown-title"><span class="title">DevOps</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/devops/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/devops/notes/" class="nav-link">
  DevOps笔记
</a></li><li class="dropdown-item"><!----> <a href="/devops/efficiency/" class="nav-link">
  研发效能
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软能力" class="dropdown-title"><span class="title">软能力</span> <span class="arrow down"></span></button> <button type="button" aria-label="软能力" class="mobile-dropdown-title"><span class="title">软能力</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/softskills/mind/" class="nav-link">
  思考模型
</a></li><li class="dropdown-item"><!----> <a href="/softskills/communication/" class="nav-link">
  沟通能力
</a></li></ul></div></div><div class="nav-item"><a href="/opensource/" class="nav-link">
  开源前哨
</a></div><div class="nav-item"><a href="/memo/" class="nav-link">
  备忘录
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试指南
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软件测试体系" class="dropdown-title"><span class="title">软件测试体系</span> <span class="arrow down"></span></button> <button type="button" aria-label="软件测试体系" class="mobile-dropdown-title"><span class="title">软件测试体系</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/qa/basics/" class="nav-link">
  测试基础
</a></li><li class="dropdown-item"><!----> <a href="/qa/automatic/" class="nav-link">
  自动测试
</a></li><li class="dropdown-item"><!----> <a href="/qa/performance/" class="nav-link">
  性能测试
</a></li><li class="dropdown-item"><!----> <a href="/qa/special/" class="nav-link">
  专项测试
</a></li><li class="dropdown-item"><!----> <a href="/qa/security/" class="nav-link">
  安全测试
</a></li><li class="dropdown-item"><!----> <a href="/qa/tool/" class="nav-link">
  测试工具
</a></li><li class="dropdown-item"><!----> <a href="/qa/framework/" class="nav-link">
  测试框架
</a></li><li class="dropdown-item"><!----> <a href="/qa/view/" class="nav-link">
  测试思考
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="计算机基础" class="mobile-dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/network/" class="nav-link">
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/basic/os/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/basic/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/basic/algorithms/" class="nav-link">
  数据结构与算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">前端游乐场</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">前端游乐场</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontend/vue/" class="nav-link">
  VUE
</a></li><li class="dropdown-item"><!----> <a href="/frontend/css/" class="nav-link">
  CSS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端训练场" class="dropdown-title"><span class="title">后端训练场</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端训练场" class="mobile-dropdown-title"><span class="title">后端训练场</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          编程语言
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/python/" class="nav-link">
  Python
</a></li><li class="dropdown-subitem"><a href="/backend/java/" class="nav-link">
  Java
</a></li></ul></li><li class="dropdown-item"><h4>
          WEB框架
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/django/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Django
</a></li><li class="dropdown-subitem"><a href="/backend/drf/" class="nav-link">
  Django REST Framework
</a></li></ul></li><li class="dropdown-item"><h4>
          中间件
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/celery/" class="nav-link">
  Celery
</a></li></ul></li><li class="dropdown-item"><h4>
          数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-subitem"><a href="/backend/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-subitem"><a href="/backend/mongodb/" class="nav-link">
  Mongodb
</a></li><li class="dropdown-subitem"><a href="/backend/elasticsearch/" class="nav-link">
  Elasticsearch
</a></li></ul></li><li class="dropdown-item"><h4>
          部署
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/uwsgi/" class="nav-link">
  Uwsgi
</a></li><li class="dropdown-subitem"><a href="/backend/gunicorn/" class="nav-link">
  Gunicorn
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="DevOps" class="dropdown-title"><span class="title">DevOps</span> <span class="arrow down"></span></button> <button type="button" aria-label="DevOps" class="mobile-dropdown-title"><span class="title">DevOps</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/devops/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/devops/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/devops/notes/" class="nav-link">
  DevOps笔记
</a></li><li class="dropdown-item"><!----> <a href="/devops/efficiency/" class="nav-link">
  研发效能
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="软能力" class="dropdown-title"><span class="title">软能力</span> <span class="arrow down"></span></button> <button type="button" aria-label="软能力" class="mobile-dropdown-title"><span class="title">软能力</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/softskills/mind/" class="nav-link">
  思考模型
</a></li><li class="dropdown-item"><!----> <a href="/softskills/communication/" class="nav-link">
  沟通能力
</a></li></ul></div></div><div class="nav-item"><a href="/opensource/" class="nav-link">
  开源前哨
</a></div><div class="nav-item"><a href="/memo/" class="nav-link">
  备忘录
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试指南
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>目录</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/django/" aria-current="page" class="active sidebar-link">Django基础知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/django/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/backend/django/#特点" class="sidebar-link">特点</a></li><li class="sidebar-sub-header"><a href="/backend/django/#项目搭建" class="sidebar-link">项目搭建</a></li><li class="sidebar-sub-header"><a href="/backend/django/#项目配置" class="sidebar-link">项目配置</a></li><li class="sidebar-sub-header"><a href="/backend/django/#请求响应" class="sidebar-link">请求响应</a></li><li class="sidebar-sub-header"><a href="/backend/django/#类视图与中间件" class="sidebar-link">类视图与中间件</a></li><li class="sidebar-sub-header"><a href="/backend/django/#模板" class="sidebar-link">模板</a></li><li class="sidebar-sub-header"><a href="/backend/django/#数据库" class="sidebar-link">数据库</a></li><li class="sidebar-sub-header"><a href="/backend/django/#asgi" class="sidebar-link">ASGI</a></li><li class="sidebar-sub-header"><a href="/backend/django/#admin站点" class="sidebar-link">admin站点</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#简介">简介</a></li><li><a href="#特点">特点</a><ul><li><a href="#重量级框架">重量级框架</a></li><li><a href="#mvt模式">MVT模式</a></li></ul></li><li><a href="#项目搭建">项目搭建</a><ul><li><a href="#环境安装">环境安装</a></li><li><a href="#创建项目">创建项目</a></li><li><a href="#创建应用">创建应用</a></li><li><a href="#创建视图">创建视图</a></li></ul></li><li><a href="#项目配置">项目配置</a><ul><li><a href="#配置文件">配置文件</a></li><li><a href="#路由">路由</a></li></ul></li><li><a href="#请求响应">请求响应</a><ul><li><a href="#请求request">请求Request</a></li><li><a href="#响应response">响应Response</a></li><li><a href="#cookie">Cookie</a></li><li><a href="#session">Session</a></li><li><a href="#session共享">Session共享</a></li><li><a href="#cookie和session的作用">Cookie和Session的作用</a></li></ul></li><li><a href="#类视图与中间件">类视图与中间件</a><ul><li><a href="#类视图">类视图</a></li><li><a href="#反射">反射</a></li><li><a href="#反射作用">反射作用</a></li><li><a href="#应用场景">应用场景</a></li><li><a href="#中间件">中间件</a></li></ul></li><li><a href="#模板">模板</a><ul><li><a href="#django自带模板">Django自带模板</a></li><li><a href="#jinja模板">Jinja模板</a></li></ul></li><li><a href="#数据库">数据库</a><ul><li><a href="#orm框架">ORM框架</a></li><li><a href="#配置">配置</a></li><li><a href="#定义模型类">定义模型类</a></li><li><a href="#迁移">迁移</a></li><li><a href="#添加测试数据">添加测试数据</a></li><li><a href="#演示工具使用">演示工具使用</a></li><li><a href="#查看mysql数据库日志">查看MySQL数据库日志</a></li><li><a href="#数据库操作">数据库操作</a></li></ul></li><li><a href="#asgi">ASGI</a><ul><li><a href="#web应用程序和web服务器">Web应用程序和web服务器</a></li><li><a href="#网关接口">网关接口</a></li><li><a href="#为什么有asgi的出现">为什么有ASGI的出现</a></li><li><a href="#asgi的使用">ASGI的使用</a></li><li><a href="#"></a></li></ul></li><li><a href="#admin站点">admin站点</a><ul><li><a href="#使用admin站点">使用Admin站点</a></li><li><a href="#调整列表页展示">调整列表页展示</a></li><li><a href="#调整编辑页展示">调整编辑页展示</a></li><li><a href="#上传图片">上传图片</a></li></ul></li></ul></div><p></p> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <ul><li>用python语言写的开源web开发框架，并遵循MVC设计；</li> <li>Django的主要目的是简便、快速的开发数据库驱动的网站；</li> <li>它强调代码复用，多个组件可以很方便的以&quot;插件&quot;形式服务于整个框架；</li> <li>Django有许多功能强大的第三方插件，你甚至可以很方便的开发出自己的工具包；</li> <li>这使得Django具有很强的可扩展性；</li> <li>它还强调快速开发和DRY(DoNotRepeatYourself)原则。</li></ul> <h2 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h2> <h3 id="重量级框架"><a href="#重量级框架" class="header-anchor">#</a> 重量级框架</h3> <p>对比Flask框架，Django原生提供了众多的功能组件，让开发更简便快速。</p> <ol><li>提供项目工程管理的自动化脚本工具</li> <li>数据库ORM支持（对象关系映射，英语：Object Relational Mapping）</li> <li>模板</li> <li>表单</li> <li>Admin管理站点</li> <li>文件管理</li> <li>认证权限</li> <li>session机制</li> <li>缓存</li></ol> <h3 id="mvt模式"><a href="#mvt模式" class="header-anchor">#</a> MVT模式</h3> <ol><li>有一种程序设计模式叫MVC，其核心思想是分工、解耦，让不同的代码块之间降低耦合，增强代码的可扩展性和可移植性，实现向后兼容；
<ul><li>M全拼为Model，主要封装对数据库层的访问，对数据库中的数据进行增、删、改、查操作；</li> <li>V全拼为View，用于封装结果，生成页面展示的html内容；</li> <li>C全拼为Controller，用于接收请求，处理业务逻辑，与Model和View交互，返回结果。</li></ul></li> <li>Django的MVT
<ul><li>M全拼为Model，与MVC中的M功能相同，负责和数据库交互，进行数据处理；</li> <li>V全拼为View，与MVC中的C功能相同，接收请求，进行业务处理，返回应答；</li> <li>T全拼为Template，与MVC中的V功能相同，负责封装构造要返回的html。</li></ul></li></ol> <h2 id="项目搭建"><a href="#项目搭建" class="header-anchor">#</a> 项目搭建</h2> <h3 id="环境安装"><a href="#环境安装" class="header-anchor">#</a> 环境安装</h3> <p>创建虚拟环境（不想创建你随意~）</p> <div class="language-shell script line-numbers-mode"><pre class="language-shell"><code>pip3 <span class="token function">install</span> virtualenv
virtualenv venv
如果存在多个python解释器，可以选择指定一个Python解释器（比如python3.6）
virtualenv -p python3.6 venv
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>安装Django</p> <div class="language-shell script line-numbers-mode"><pre class="language-shell"><code>pip3 <span class="token function">install</span> Django
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Virtualenv相关命令总结：</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ul><li>workon: 打印所有的虚拟环境；</li> <li>mkvirtualenv xxx: 创建 xxx 虚拟环境，可以–python=/usr/bin/python3.6 指定python版本;</li> <li>workon xxx: 使用 xxx 虚拟环境;</li> <li>deactivate: 退出 xxx 虚拟环境；</li> <li>rmvirtualenv xxx: 删除 xxx 虚拟环境。</li> <li>lsvirtualenv : 列举所有的环境。</li></ul></div> <h3 id="创建项目"><a href="#创建项目" class="header-anchor">#</a> 创建项目</h3> <ol><li>创建项目</li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>django<span class="token operator">-</span>admin startproject project
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li>项目目录说明
<ul><li>与项目同名的目录，此处为xxx；</li> <li>settings.py 是项目的整体配置文件；</li> <li>urls.py 是项目的URL配置文件；</li> <li>wsgi.py 是项目与WSGI兼容的Web服务器入口；</li> <li>manage.py 是项目管理文件，通过它管理项目。</li></ul></li> <li>启动本地服务，django提供了一个纯python编写的轻量级web服务器</li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>python manage<span class="token punctuation">.</span>py runserver ip<span class="token punctuation">:</span>port
（或者）
python manage<span class="token punctuation">.</span>py runserver
可以不写IP和端口，默认IP是<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>，默认端口为<span class="token number">8000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="创建应用"><a href="#创建应用" class="header-anchor">#</a> 创建应用</h3> <ol><li>创建（子）应用</li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>python manage<span class="token punctuation">.</span>py startapp app
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li>子应用目录说明：
<ul><li>admin.py 文件跟网站的后台管理站点配置相关。</li> <li>apps.py 文件用于配置当前子应用的相关信息。</li> <li>migrations 目录用于存放数据库迁移历史文件。</li> <li>models.py 文件用户保存数据库模型类。</li> <li>tests.py 文件用于开发测试用例，编写单元测试。</li> <li>views.py 文件用于编写Web应用视图。</li></ul></li> <li>注册子应用
注册安装一个子应用的方法，即是将子应用的配置信息文件apps.py中的Config类添加到项目配置文件settings.py中INSTALLED_APPS列表中。</li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'django.contrib.admin'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.auth'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.contenttypes'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.sessions'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.messages'</span><span class="token punctuation">,</span>
    <span class="token string">'django.contrib.staticfiles'</span><span class="token punctuation">,</span>
    <span class="token string">'rest_framework'</span><span class="token punctuation">,</span> <span class="token comment"># 新增</span>
    <span class="token string">'blog'</span><span class="token punctuation">,</span> <span class="token comment"># 新增</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如果django版本较低，或者避免自定义app名与第三方库存在冲突，可以使用应用.apps.类名这样的写法，比如blog.apps.BlogConfig</p> <h3 id="创建视图"><a href="#创建视图" class="header-anchor">#</a> 创建视图</h3> <ol><li>进入创建的应用模块，在views.py中编写视图<div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    index视图
    :param request: 包含了请求信息的请求对象
    :return: 响应对象
    &quot;&quot;&quot;</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">&quot;hello the world!&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div>说明
<ul><li>视图函数的第一个传入参数必须定义，用于接收Django构造的包含了请求数据的HttpReqeust对象，通常名为request;</li> <li>视图函数的返回值必须为一个响应对象，不能像Flask一样直接返回一个字符串，可以将要返回的字符串数据放到一个HTTPResponse对象中。</li></ul></li> <li>进入创建的应用模块，在urls.py中保存应用路由</li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url	
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views	
<span class="token comment"># urlpatterns是被django自动识别的路由列表变量</span>
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token comment"># 每个路由信息都需要使用url函数来构造</span>
	<span class="token comment"># url(路径, 视图)</span>
	url<span class="token punctuation">(</span><span class="token string">r'^index/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language- extra-class"><pre><code>URL传递参数
	- 无参数情况
	```python
	(r’^hello/$’, hello)
	def hello(request):
	    return HttpResponse(&quot;Hello World&quot;)
	```
	- 传递一个参数
	```python
	(r’^plist/(.+)/$’, helloParam）
	def helloParam(request，param):
	    return HttpResponse(param)
	```
	- 传递多个参数
	```python
	(r’^plist/p1(\w+)p2(.+)/$’, helloParams）
	def helloParams(request，param1,param2):
	    return HttpResponse(param1;param2)
	访问http://127.0.0.1:8000/plist/p1chinap22022/
	输出为”china;2022″
	```
- 从这里可以看出，视图的参数是根据URL的正则式，按顺序匹配并自动赋值的。虽然这样可以实现任意多个参数的传递，但是却不够灵活，URL看起来很混乱，而且由于是正则匹配，有些情况下容易出错
- **通过传统的”?”传递参数**
	- 例如，http://127.0.0.1:8000/plist/?p1=china&amp;p2=2012，url中‘?’之后表示传递的参数，这里传递了p1和p2两个参数。
	- 通过这样的方式传递参数，就不会出现因为正则匹配错误而导致的问题了。在Django中，此类参数的解析是通过request.GET.get方法获取的。
	- 配置URL及其视图如下：
	```python
	(r’^plist/$’, helloParams1）
	def helloParams(request):
		p1 = request.GET.get('p1')
		p2 = request.GET.get('p2')
		return HttpResponse(&quot;p1 = &quot; + p1 + &quot;; p2 = &quot; + p2)
	输出结果为”p1 = china; p2 = 2012″
	```
- **使用关键字参数而非位置参数**
	- 在 Python 正则表达式中，命名的正则表达式组的语法是 (?P&lt;name&gt;pattern) ，这里 name 是组的名字，而pattern 是匹配的某个模式。
	- 使用无名组
	```python
	urlpatterns = patterns('',
		(r'^articles/(\d{4})/$', views.year_archive),
		(r'^articles/(\d{4})/(\d{2})/$', views.month_archive),
	)
	```
	- 使用命名组
	```python
	urlpatterns = patterns('',
	    (r'^articles/(?P&lt;year&gt;\d{4})/$', views.year_archive),
	    (r'^articles/(?P&lt;year&gt;\d{4})/(?P&lt;month&gt;\d{2})/$', views.month_archive),
	)
	```
	- 如果不带命名组，请求 /articles/2022/06/ 将会等同于这样的函数调用：
    ```python
	month_archive(request, '2022', '06')
	```
	- 而带命名组，同样的请求就会变成这样的函数调用：
	```python
	month_archive(request, year='2022', month='06')
	```
	- 需要注意的是如果在URLconf中使用命名组，那么命名组和非命名组是不能同时存在于同一个URLconf的模式中的。 如果你这样做，Django不会抛出任何错误，但你可能会发现你的URL并没有像你预想的那样匹配正确。
	- 具体地，以下是URLconf解释器有关正则表达式中命名组和 非命名组所遵循的算法:
		- 如果有任何命名的组，Django会忽略非命名组而直接使用命名组。
		- 否则，Django会把所有非命名组以位置参数的形式传递。
		- 在以上的两种情况，Django同时会以关键字参数的方式传递一些额外参数。
</code></pre></div><ol><li>在项目总路由project/urls.py中添加子应用的路由数据</li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url<span class="token punctuation">,</span> include
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin	
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
	url<span class="token punctuation">(</span><span class="token string">r'^admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># django默认包含的	</span>
	url<span class="token punctuation">(</span><span class="token string">r'^app/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'app.urls'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>备注
<ul><li>使用include来将子应用app里的全部路由包含进项目路由中；</li> <li>r'^app/' 决定了app子应用的所有路由都已/app/开头，如我们刚定义的视图index，其最终的完整访问路径为/app/index/；</li> <li>include函数除了可以传递字符串之外，也可以直接传递应用的urls模块。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url<span class="token punctuation">,</span> include
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">import</span> users<span class="token punctuation">.</span>urls  <span class="token comment"># 先导入应用的urls模块	</span>
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
	url<span class="token punctuation">(</span><span class="token string">r'^admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>
	url<span class="token punctuation">(</span><span class="token string">r'^users/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span>app<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 添加应用的路由</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul> <h2 id="项目配置"><a href="#项目配置" class="header-anchor">#</a> 项目配置</h2> <h3 id="配置文件"><a href="#配置文件" class="header-anchor">#</a> 配置文件</h3> <ol><li>BASE_DIR
当前工程的根目录，Django会依此来定位工程内的相关文件，我们也可以使用该参数来构造文件路径</li> <li>DEBUG
<ul><li>调试模式，创建工程后初始值为True，即默认工作在调试模式下</li> <li>Django程序出现异常时，向前端显示详细的错误追踪信息</li> <li>部署线上运行的Django不要运行在调式模式下，记得修改DEBUG=False</li></ul></li> <li>语言与时区<div class="language-python line-numbers-mode"><pre class="language-python"><code>LANGUAGE_CODE <span class="token operator">=</span> <span class="token string">'zh-hans'</span>
TIME_ZONE <span class="token operator">=</span> <span class="token string">'Asia/Shanghai'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li>静态文件
<ul><li>项目中的CSS、图片、js都是静态文件。一般会将静态文件放到一个单独的目录中，以方便管理；</li> <li>静态文件可以放在项目根目录下，也可以放在应用的目录下，由于有些静态文件在项目中是通用的，所以推荐放在项目的根目录下，方便管理；</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>STATICFILES_DIRS<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span> 存放查找静态文件的目录 接收的是<span class="token builtin">list</span>
STATIC_URL 访问静态文件的URL前缀
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div>Django 仅在调试模式下（DEBUG=True）能对外提供静态文件；当DEBUG=False工作在生产模式时，Django不再对外提供静态文件，需要是用collectstatic命令来收集静态文件并交由其他静态文件服务器来提供。</li></ol> <h3 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h3> <h4 id="路由说明"><a href="#路由说明" class="header-anchor">#</a> 路由说明</h4> <ul><li>Django的主要路由信息定义在工程同名目录下的urls.py文件中，该文件是Django解析路由的入口；</li> <li>每个子应用为了保持相对独立，可以在各个子应用中定义属于自己的urls.py来保存该应用的路由，然后用主路由文件包含各应用的子路由数据。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">import</span> app<span class="token punctuation">.</span>views
urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
	url<span class="token punctuation">(</span><span class="token string">r'^admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>
	url<span class="token punctuation">(</span><span class="token string">r'^app/index/$'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>views<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="路由解析顺序"><a href="#路由解析顺序" class="header-anchor">#</a> 路由解析顺序</h4> <ul><li>Django在接收到一个请求时，从主路由文件中的urlpatterns列表中以由上至下的顺序查找对应路由规则;</li> <li>如果发现规则为include包含，则再进入被包含的urls中的urlpatterns列表由上至下进行查询;</li> <li>值得关注的由上至下的顺序，有可能会使上面的路由屏蔽掉下面的路由，带来非预期结果。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
	url<span class="token punctuation">(</span><span class="token string">r'^say'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>say<span class="token punctuation">)</span><span class="token punctuation">,</span>
	url<span class="token punctuation">(</span><span class="token string">r'^sayhello'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>sayhello<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="路由命名与reverse反解析-逆向"><a href="#路由命名与reverse反解析-逆向" class="header-anchor">#</a> 路由命名与reverse反解析（逆向）</h4> <ol><li>在定义路由的时候，可以为路由命名，方便查找特定视图的具体路径信息；
<ul><li>在使用include函数定义路由时，可以使用namespace参数定义路由的命名空间；<div class="language-python line-numbers-mode"><pre class="language-python"><code>url<span class="token punctuation">(</span><span class="token string">r'^users/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">'users.urls'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>此命名空间表示，凡是users.urls中定义的路由，均属于namespace指明的users名下；</li> <li>命名空间的作用是避免不同应用中的路由使用了相同的名字发生冲突，使用命名空间区别开。</li></ul></li> <li>在定义普通路由（非include函数）时，可以使用name参数指明路由的名字；</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span><span class="token string">r'^index/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    url<span class="token punctuation">(</span><span class="token string">r'^say'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>say<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'say'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li>reverse反解析<div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> reverse
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">&quot;hello the world!&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">say</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	url <span class="token operator">=</span> reverse<span class="token punctuation">(</span><span class="token string">'users:index'</span><span class="token punctuation">)</span>  <span class="token comment"># 返回 /users/index/</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div>对于未指明namespace的，reverse(路由name)；对于指明namespace的，reverse(命名空间namespace:路由name)</li></ol> <h4 id="路径结尾斜线-的说明"><a href="#路径结尾斜线-的说明" class="header-anchor">#</a> 路径结尾斜线/的说明</h4> <ul><li>Django中定义路由时，通常以斜线“/”结尾，其好处是用户访问不以斜线“/”结尾的相同路径时，Django会把用户重定向到以斜线“/”结尾的路径上，而不会返回404。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
	url<span class="token punctuation">(</span><span class="token string">r'^index/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>用户访问index或者index/网址，均能访问到index视图；</li> <li>虽然路由结尾带/能带来上述好处，但是却违背了HTTP中URL表示资源位置路径的设计理念；</li> <li>SO，是否结尾带“/”，你自己看着办咯！</li></ul> <h2 id="请求响应"><a href="#请求响应" class="header-anchor">#</a> 请求响应</h2> <h3 id="请求request"><a href="#请求request" class="header-anchor">#</a> 请求Request</h3> <ol><li>利用HTTP协议向服务器传参有几种途径？
<ul><li>提取URL的特定部分，如/weather/beijing/2018，可以在服务器端的路由中用正则表达式截取；</li> <li>查询字符串（query string)，形如key1=value1&amp;key2=value2；</li> <li>请求体（body）中发送的数据，比如表单数据、json、xml；</li> <li>在http报文的头（header）中。</li></ul></li> <li>URL路径参数
<ul><li>在定义路由URL时，可以使用正则表达式提取参数的方法从URL中获取请求参数，Django会将提取的参数直接传递到视图的传入参数中。</li> <li>未命名参数按定义顺序传递</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>url<span class="token punctuation">(</span><span class="token string">r'^weather/([a-z]+)/(\d{4})/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>weather<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">def</span> <span class="token function">weather</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> city<span class="token punctuation">,</span> year<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'city=%s'</span> <span class="token operator">%</span> city<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'year=%s'</span> <span class="token operator">%</span> year<span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>命名参数按名字传递</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>url<span class="token punctuation">(</span><span class="token string">r'^weather/(?P&lt;city&gt;[a-z]+)/(?P&lt;year&gt;\d{4})/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>weather<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">def</span> <span class="token function">weather</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> year<span class="token punctuation">,</span> city<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'city=%s'</span> <span class="token operator">%</span> city<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'year=%s'</span> <span class="token operator">%</span> year<span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li>Django中的QueryDict对象
<ul><li>定义在django.http.QueryDict；</li> <li>HttpRequest对象的属性GET、POST都是QueryDict类型的对象；</li> <li>与python字典不同，QueryDict类型的对象用来处理同一个键带有多个值的情况；</li> <li>方法get()：根据键获取值
如果一个键同时拥有多个值将获取最后一个值；如果键不存在则返回None值，可以设置默认值进行后续处理<div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">dict</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'键'</span><span class="token punctuation">,</span>默认值<span class="token punctuation">)</span>
可简写为
<span class="token builtin">dict</span><span class="token punctuation">[</span><span class="token string">'键'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li>方法getlist()：根据键获取值，值以列表返回，可以获取指定键的所有值
如果键不存在则返回空列表[]，可以设置默认值进行后续处理<div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token builtin">dict</span><span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">'键'</span><span class="token punctuation">,</span>默认值<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li>查询字符串Query String
<ul><li>获取请求路径中的查询字符串参数（形如?k1=v1&amp;k2=v2），可以通过request.GET属性获取，返回QueryDict对象</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># /qs/?a=1&amp;b=2&amp;a=3</span>
<span class="token keyword">def</span> <span class="token function">qs</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	a <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
	b <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>
	alist <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token comment"># 3</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>  <span class="token comment"># 2</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>alist<span class="token punctuation">)</span>  <span class="token comment"># ['1', '3']</span>
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>查询字符串不区分请求方式，即假使客户端进行POST方式的请求，依然可以通过request.GET获取请求中的查询字符串数据。</li></ul></li> <li>请求体
<ul><li>请求体数据格式不固定，可以是表单类型字符串，可以是JSON字符串，可以是XML字符串，应区别对待；</li> <li>可以发送请求体数据的请求方式有POST、PUT、PATCH、DELETE；</li> <li>Django默认开启了CSRF防护，会对上述请求方式进行CSRF防护验证，在测试时可以关闭CSRF防护机制，方法为在settings.py文件中注释掉CSRF中间件。</li> <li>表单类型 Form Data（application/x-www-form-urlencoded）
<ul><li>前端发送的表单类型的请求体数据，可以通过request.POST属性获取，返回QueryDict对象</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_body</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	a <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
	b <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span>
	alist <span class="token operator">=</span> request<span class="token punctuation">.</span>POST<span class="token punctuation">.</span>getlist<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>alist<span class="token punctuation">)</span>
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>request.POST只能用来获取POST方式的请求体表单数据</li></ul></li> <li>非表单类型 Non-Form Data（application/json）
<ul><li>非表单类型的请求体数据，Django无法自动解析，可以通过request.body属性获取最原始的请求体数据；</li> <li>自己按照请求体格式（JSON、XML等）进行解析；</li> <li>request.body返回bytes类型。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>如请求体为JSON数据：<span class="token punctuation">{</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
<span class="token keyword">import</span> json	
<span class="token keyword">def</span> <span class="token function">get_body_json</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	json_str <span class="token operator">=</span> request<span class="token punctuation">.</span>body
	json_str <span class="token operator">=</span> json_str<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># python3.6 无需执行此步</span>
	req_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>req_data<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>req_data<span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ul></li> <li>请求头
<ul><li>可以通过request.META属性获取请求头headers中的数据，request.META为字典类型</li> <li>常见的请求头如：
<ul><li>CONTENT_LENGTH – The length of the request body (as a string).</li> <li>CONTENT_TYPE – The MIME type of the request body.</li> <li>HTTP_ACCEPT – Acceptable content types for the response.</li> <li>HTTP_ACCEPT_ENCODING – Acceptable encodings for the response.</li> <li>HTTP_ACCEPT_LANGUAGE – Acceptable languages for the response.</li> <li>HTTP_HOST – The HTTP Host header sent by the client.</li> <li>HTTP_REFERER – The referring page, if any.</li> <li>HTTP_USER_AGENT – The client’s user-agent string.</li> <li>QUERY_STRING – The query string, as a single (unparsed) string.</li> <li>REMOTE_ADDR – The IP address of the client.</li> <li>REMOTE_HOST – The hostname of the client.</li> <li>REMOTE_USER – The user authenticated by the Web server, if any.</li> <li>REQUEST_METHOD – A string such as &quot;GET&quot; or &quot;POST&quot;.</li> <li>SERVER_NAME – The hostname of the server.</li> <li>SERVER_PORT – The port of the server (as a string).</li></ul></li> <li>具体使用</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">get_headers</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>META<span class="token punctuation">[</span><span class="token string">'CONTENT_TYPE'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li>其他常用HttpRequest对象属性
<ul><li>method：一个字符串，表示请求使用的HTTP方法，常用值包括：'GET'、'POST'；</li> <li>user：请求的用户对象；</li> <li>path：一个字符串，表示请求的页面的完整路径，不包含域名和参数部分；</li> <li>encoding：一个字符串，表示提交的数据的编码方式；
<ul><li>如果为None则表示使用浏览器的默认设置，一般为utf-8；</li> <li>这个属性是可写的，可以通过修改它来修改访问表单数据使用的编码，接下来对属性的任何访问将使用新的encoding值；</li></ul></li> <li>FILES：一个类似于字典的对象，包含所有的上传文件。</li> <li>GET：QueryDict类型对象，类似于字典，包含get请求方式的所有参数。</li> <li>POST：QueryDict类型对象，类似于字典，包含post请求方式的所有参数。</li> <li>COOKIES：一个标准的Python字典，包含所有的cookie，键和值都为字符串。</li> <li>SESSION：一个既可读又可写的类似于字典的对象，表示当前的会话，只有当Django 启用会话的支持时才可用。</li> <li>body： http请求的主体，二进制格式。</li> <li>data：Django中标准的request.POST和request.FILES属性，drf中可以返回请求体的解析内容。</li> <li>query_params：request.query_params等同于request.GET，不过其名字更加容易理解。为了代码更加清晰可读，推荐使用request.query_params ，而不是Django中的request.GET，这样那够让你的代码更加明显的体现出，任何HTTP method类型都可能包含查询参数（query parameters），而不仅仅只是GET请求。</li> <li>parsers：APIView类或者@api_view装饰器将根据视图上设置的parser_classes或settings文件中的DEFAULT_PARSER_CLASSES设置来确保此属性（.parsers）自动设置为 Parser 实例列表。通常不需要关注该属性</li></ul></li></ol> <h3 id="响应response"><a href="#响应response" class="header-anchor">#</a> 响应Response</h3> <ul><li>视图在接收请求并处理后，必须返回HttpResponse对象或子对象；</li> <li>HttpRequest对象由Django创建，HttpResponse对象由开发人员创建。</li></ul> <ol><li><p>HttpResponse</p> <ul><li>可以使用django.http.HttpResponse来构造响应对象</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>HttpResponse<span class="token punctuation">(</span>content<span class="token operator">=</span>响应体<span class="token punctuation">,</span> content_type<span class="token operator">=</span>响应体数据类型<span class="token punctuation">,</span> status<span class="token operator">=</span>状态码<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>也可通过HttpResponse对象属性来设置响应体、状态码：</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>content：表示返回的内容。
status_code：返回的HTTP响应状态码。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>响应头可以直接将HttpResponse对象当做字典进行响应头键值对的设置</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>response <span class="token operator">=</span> HttpResponse<span class="token punctuation">(</span><span class="token punctuation">)</span>
response<span class="token punctuation">[</span><span class="token string">'xxx'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Python'</span>  <span class="token comment"># 自定义响应头xxx, 值为Python</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>示例：</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse
<span class="token keyword">def</span> <span class="token function">demo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'python'</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span>
	或者
	response <span class="token operator">=</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'python'</span><span class="token punctuation">)</span>
	response<span class="token punctuation">.</span>status_code <span class="token operator">=</span> <span class="token number">400</span>
	response<span class="token punctuation">[</span><span class="token string">'xxx'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Python'</span>
	<span class="token keyword">return</span> response
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>HttpResponse子类
Django提供了一系列HttpResponse的子类，可以快速设置状态码</p> <ul><li>HttpResponseRedirect 301</li> <li>HttpResponsePermanentRedirect 302</li> <li>HttpResponseNotModified 304</li> <li>HttpResponseBadRequest 400</li> <li>HttpResponseNotFound 404</li> <li>HttpResponseForbidden 403</li> <li>HttpResponseNotAllowed 405</li> <li>HttpResponseGone 410</li> <li>HttpResponseServerError 500</li></ul></li> <li><p>JsonResponse
若要返回json数据，可以使用JsonResponse来构造响应对象，作用如下：</p> <ul><li>帮助我们将数据转换为json字符串</li> <li>设置响应头Content-Type为 application/json</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> JsonResponse	
<span class="token keyword">def</span> <span class="token function">demo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'chengdu'</span><span class="token punctuation">,</span> <span class="token string">'subject'</span><span class="token punctuation">:</span> <span class="token string">'python'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>Response</p> <ul><li>drf自己封装的方法，会有一个简单的web接口界面</li> <li>与普通 HttpResponse 对象不同，您不会使用渲染的内容实例化 Response 对象。相反，您传递的是未渲染的数据，可能包含任何 Python 对象。</li> <li>由于 Response 类使用的渲染器不能处理复杂的数据类型（比如 Django 的模型实例），所以需要在创建 Response 对象之前将数据序列化为基本的数据类型。</li></ul></li> <li><p>重定向简写redirect</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> redirect
<span class="token keyword">def</span> <span class="token function">demo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/index.html'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>重定向HttpResponseRedirect
HttpResponseRedirect对象实现重定向功能，这个类继承自HttpResponse，被定义在django.http模块中，返回的状态码为302</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponseRedirect
<span class="token comment"># 定义重定义向视图，转向首页</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> HttpResponseRedirect<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'h1'</span><span class="token punctuation">:</span> <span class="token string">'hello'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>render
结合一个给定的模板和一个给定的上下文字典, 并返回一个渲染后的HttpResponse对象。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">def</span> <span class="token function">my_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 视图代码写在这里</span>
	<span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">&quot;myapp/index.html&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ol> <h3 id="cookie"><a href="#cookie" class="header-anchor">#</a> Cookie</h3> <ol><li>HTTP 协议中的 Cookie 包括 Web Cookie 和浏览器 Cookie，它是服务器发送到 Web 浏览器的一小块数据。服务器发送到浏览器的 Cookie，浏览器会进行存储，并与下一个请求一起发送到服务器。通常，它用于判断两个请求是否来自于同一个浏览器，例如用户保持登录状态。</li> <li>Cookie，有时也用其复数形式Cookies，指某些网站为了辨别用户身份、进行session跟踪而储存在用户本地终端上的数据（通常经过加密）；</li> <li>Cookie是存储在浏览器中的一段纯文本信息，建议不要存储敏感信息如密码，因为电脑上的浏览器可能被其它人使用。</li> <li>Cookie的特点：
<ul><li>Cookie以键值对Key-Value形势进行信息的存储；</li> <li>Cookie基于域名安全，不同域名的Cookie是不能互相访问的。</li></ul></li> <li>Cookie 主要用于下面三个目的
<ul><li>会话管理：登录、购物车、游戏得分或者服务器应该记住的其他内容</li> <li>个性化：用户偏好、主题或者其他设置</li> <li>追踪：记录和分析用户行为</li></ul></li> <li>有两种类型的 Cookies，一种是 Session Cookies，一种是 Persistent Cookies，如果 Cookie 不包含到期日期，则将其视为会话 Cookie。会话 Cookie 存储在内存中，永远不会写入磁盘，当浏览器关闭时，此后 Cookie 将永久丢失。如果 Cookie 包含有效期 ，则将其视为持久性 Cookie。在到期指定的日期，Cookie 将从磁盘中删除。</li> <li>Cookie的 Secure 和 HttpOnly 标记
<ul><li>安全的 Cookie 需要经过 HTTPS 协议通过加密的方式发送到服务器。即使是安全的，也不应该将敏感信息存储在cookie 中，因为它们本质上是不安全的，并且此标志不能提供真正的保护。</li> <li>HttpOnly 的作用
<ul><li>会话 Cookie 中缺少 HttpOnly 属性会导致攻击者可以通过程序(JS脚本、Applet等)获取到用户的 Cookie 信息，造成用户 Cookie 信息泄露，增加攻击者的跨站脚本攻击威胁。</li> <li>HttpOnly 是微软对 Cookie 做的扩展，该值指定 Cookie 是否可通过客户端脚本访问。</li> <li>如果在 Cookie 中没有设置 HttpOnly 属性为 true，可能导致 Cookie 被窃取。窃取的 Cookie 可以包含标识站点用户的敏感信息，如 ASP.NET 会话 ID 或 Forms 身份验证票证，攻击者可以重播窃取的 Cookie，以便伪装成用户或获取敏感信息，进行跨站脚本攻击等。</li></ul></li></ul></li> <li>Cookie 的作用域
<ul><li>Domain 和 Path 标识定义了 Cookie 的作用域：即 Cookie 应该发送给哪些 URL。</li> <li>Domain 标识指定了哪些主机可以接受 Cookie。如果不指定，默认为当前主机(不包含子域名）。如果指定了Domain，则一般包含子域名。</li> <li>例如，如果设置 Domain=mozilla.org，则 Cookie 也包含在子域名中（如developer.mozilla.org）。</li> <li>例如，设置 Path=/docs，则以下地址都会匹配：
<ul><li>/docs</li> <li>/docs/Web/</li></ul></li></ul></li> <li>设置Cookie
可以通过HttpResponse对象中的set_cookie方法来设置cookie<div class="language-python line-numbers-mode"><pre class="language-python"><code>HttpResponse<span class="token punctuation">.</span>set_cookie<span class="token punctuation">(</span>cookie名<span class="token punctuation">,</span> value<span class="token operator">=</span>cookie值<span class="token punctuation">,</span> max_age<span class="token operator">=</span>cookie有效期<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div>max_age 单位为秒，默认为None；如果是临时cookie，可将max_age设置为None。</li> <li>读取Cookie
<ul><li>可以通过HttpRequest对象的COOKIES属性来读取本次请求携带的cookie值；</li> <li>request.COOKIES为字典类型。</li></ul></li></ol> <h3 id="session"><a href="#session" class="header-anchor">#</a> Session</h3> <ol><li><p>Session 是什么
客户端请求服务端，服务端会为这次请求开辟一块内存空间，这个对象便是 Session 对象，存储结构为 ConcurrentHashMap。Session 弥补了 HTTP 无状态特性，服务器可以利用 Session 存储客户端在同一个会话期间的一些操作记录。</p></li> <li><p>Session 如何判断是否是同一会话</p> <ul><li>服务器第一次接收到请求时，开辟了一块 Session 空间（创建了Session对象），同时生成一个 sessionId ，并通过响应头的 Set-Cookie：JSESSIONID=XXXXXXX 命令，向客户端发送要求设置 Cookie 的响应；客户端收到响应后，在本机客户端设置了一个 JSESSIONID=XXXXXXX 的 Cookie 信息，该 Cookie 的过期时间为浏览器会话结束。</li> <li>接下来客户端每次向同一个网站发送请求时，请求头都会带上该 Cookie 信息（包含 sessionId ）， 然后，服务器通过读取请求头中的 Cookie 信息，获取名称为 JSESSIONID 的值，得到此次请求的 sessionId。</li></ul></li> <li><p>Session 的作用</p> <ul><li>Session 的作用就是它在 Web服务器上保持用户的状态信息供在任何时间从任何设备上的页面进行访问。因为浏览器不需要存储任何这种信息，所以可以使用任何浏览器，即使是像 Pad 或手机这样的浏览器设备。</li> <li>保持会话状态!</li></ul></li> <li><p>Session 的缺点
Session 机制有个缺点，比如 A 服务器存储了 Session，就是做了负载均衡后，假如一段时间内 A 的访问量激增，会转发到 B 进行访问，但是 B 服务器并没有存储 A 的 Session，会导致 Session 的失效。</p></li> <li><p>Session的特点</p> <ul><li>存储敏感、重要的信息</li> <li>支持更多字节</li> <li>以键值对进行存储的</li> <li>依赖于cookie。存储Session时，键与Cookie中的sessionid相同，值是开发人员设置的键值对信息，进行了base64编码，过期时间由开发人员设置。</li> <li>有过期时间，如果不指定，默认两周就会过期</li> <li>存储在服务器端</li></ul></li> <li><p>禁用 Cookies，如何使用 Session ？</p> <ul><li>Q:用户禁止cookie后，服务器的sessionId还会发给用户么？</li> <li>A:会：服务器仍会将sessionId以cookie的方式发送给浏览器，但是，浏览器不再保存这个cookie(即sessionId)了。</li> <li>Q:如何设置才能在每个url后加上sessionId的值？</li> <li>A:重写url，每个url后面自动加上PHPSESSID的值，然后正常使用session就可以了。</li> <li>Q:session的生命周期中特别注意的？</li> <li>A:只要活动就不会过期：session是一个只要活动就不会过期的东西，只要开启cookie，每一次会话，session_id都不会改变</li></ul></li> <li><p>Session配置和存储</p> <ul><li>启用Session，Django项目默认启用Session，可以在settings.py文件中查看</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>如需禁用session，将上图中的session中间件注释掉即可</li> <li>存储方式</li> <li>在settings.py文件中，可以设置session数据的存储方式，可以保存在数据库、本地缓存等</li> <li><strong>数据库</strong></li> <li>存储在数据库中，如下设置可以写，也可以不写，这是默认存储方式。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>SESSION_ENGINE<span class="token operator">=</span><span class="token string">'django.contrib.sessions.backends.db'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>如果存储在数据库中，需要在项INSTALLED_APPS中安装Session应用。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token string">'django.contrib.sessions'</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>迁移后会在数据库中创建出存储Session的表，数据库中的表为：django_session，由表结构可知，操作Session包括三个数据：键，值，过期时间。
<img src="/assets/img/uTools_1654268762377.0e9d4b94.png" alt=""></li> <li><strong>本地缓存</strong></li> <li>存储在本机内存中，如果丢失则不能找回，比数据库的方式读写更快。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>SESSION_ENGINE<span class="token operator">=</span><span class="token string">'django.contrib.sessions.backends.cache'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><strong>混合存储</strong></li> <li>优先从本机内存中存取，如果没有则从数据库中存取</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>SESSION_ENGINE<span class="token operator">=</span>`django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>sessions<span class="token punctuation">.</span>backends<span class="token punctuation">.</span>cached_db`
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><strong>Redis</strong> <ul><li>在redis中保存session，需要引入第三方扩展，我们可以使用django-redis来解决</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>pip install django<span class="token operator">-</span>redis
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>配置</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>CACHES <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;default&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;BACKEND&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;django_redis.cache.RedisCache&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;LOCATION&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;redis://127.0.0.1:6379/1&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;OPTIONS&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;CLIENT_CLASS&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;django_redis.client.DefaultClient&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
SESSION_ENGINE <span class="token operator">=</span> <span class="token string">&quot;django.contrib.sessions.backends.cache&quot;</span>
SESSION_CACHE_ALIAS <span class="token operator">=</span> <span class="token string">&quot;default&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>如果redis的ip地址不是本地回环127.0.0.1，而是其他地址，访问Django时，可能出现Redis连接错误；</li> <li>需修改redis的配置文件，添加特定ip地址。
<ul><li>打开redis的配置文件</li> <li>sudo vim /etc/redis/redis.conf</li> <li>如要添加10.8.250.79地址，bind 127.0.0.1 10.8.250.79</li> <li>sudo service redis-server restart</li></ul></li></ul></li></ul></li> <li><p>设置session
通过HttpRequest对象的session属性进行会话的读写操作。</p></li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>request<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'键'</span><span class="token punctuation">]</span><span class="token operator">=</span>值
	
views<span class="token punctuation">.</span>py文件，创建视图set_session
<span class="token keyword">def</span> <span class="token function">set_session</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''设置session'''</span>
    request<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'smart'</span>
    request<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">18</span>
    <span class="token comment"># request.session.set_expiry(5)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'设置session'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>根据键读取值</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'键'</span><span class="token punctuation">,</span>默认值<span class="token punctuation">)</span>
views<span class="token punctuation">.</span>py文件，修改get_session视图如下：
<span class="token keyword">def</span> <span class="token function">get_session</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">'''获取session'''</span>
	username <span class="token operator">=</span> request<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span>
	age <span class="token operator">=</span> request<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span>
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span>username<span class="token operator">+</span><span class="token string">':'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>清除所有session，在存储中删除值部分</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>

views<span class="token punctuation">.</span>py文件，修改clear_session视图如下
<span class="token keyword">def</span> <span class="token function">clear_session</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''清除session信息'''</span>
    request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'清除成功'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>清除session数据，在存储中删除session的整条数据</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 清除所有Session</span>
<span class="token keyword">def</span> <span class="token function">clear_session</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''清除所有session信息'''</span>
    request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'清除成功'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>删除session中的指定键及值，在存储中只删除某个键及对应的值</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">del</span> request<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'键'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>设置session的有效期</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>request<span class="token punctuation">.</span>session<span class="token punctuation">.</span>set_expiry<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>如果value是一个整数，session将在value秒没有活动后过期；</li> <li>如果value为0，那么用户session的Cookie将在用户的浏览器关闭时过期；</li> <li>如果value为None，那么session有效期将采用系统默认值，默认为两周，可以通过在settings.py中设置SESSION_COOKIE_AGE来设置全局默认值。</li></ul> <h3 id="session共享"><a href="#session共享" class="header-anchor">#</a> Session共享</h3> <ol><li>基于Nginx的ip_hash负载均衡
这个方案实现最为简单，Session保存在后端服务器的内存中，只要hash属性是均匀的，多台web服务器的负载就是均衡的，安全性高，缺点：用户浏览器的IP地址hash以后满足单调性。会可能造成资源的分配不均衡，负载均衡就达不到到目的。有的服务器负载过重，有的服务器负载过轻，显然没有充分利用资源。</li> <li>基于数据库的Session共享
首选当然是大名鼎鼎的Mysql数据库，并且建议使用内存表Heap，提高session操作的读写效率。这个方案的实用性比较强，相信大家普遍在使用，它的缺点在于session的并发读写能力取决于Mysql数据库的性能，同时需要自己实现session淘汰逻辑，以便定时从数据表中更新、删除 session记录，当并发过高时容易出现表锁，虽然我们可以选择行级锁的表引擎，但不得不否认使用数据库存储Session还是有些杀鸡用牛刀的架势。</li> <li>将信息放到cookie放在客户端
<ul><li>session存在服务器端，会对服务器产生压力。如果将信息保存到cookie中，减轻了服务器的压力，同时每个客户端的压力也很小。因为只保存自己的信息。这种方式在实际的开发中广泛的采用。</li> <li>缺点：cookie可以被禁用，cookie要随着浏览器传递，增大了传输的内容，cookie大小有限制。</li></ul></li> <li>基于Redis做缓存session的统一缓存
其实就是把每次用户的请求的时候生成的sessionID给放到Redis的服务器上。然后在基于Redis的特性进行设置一个失效时间的机制，这样就能保证用户在我们设置的Redis中的session失效时间内，都不需要进行再次登录。</li></ol> <h3 id="cookie和session的作用"><a href="#cookie和session的作用" class="header-anchor">#</a> Cookie和Session的作用</h3> <p>HTTP 协议是一种无状态协议，即每次服务端接收到客户端的请求时，都是一个全新的请求，服务器并不知道客户端的历史请求记录；Session 和 Cookie 的主要目的就是为了弥补 HTTP的无状态特性。</p> <h2 id="类视图与中间件"><a href="#类视图与中间件" class="header-anchor">#</a> 类视图与中间件</h2> <h3 id="类视图"><a href="#类视图" class="header-anchor">#</a> 类视图</h3> <h4 id="引入"><a href="#引入" class="header-anchor">#</a> 引入</h4> <ol><li>以函数的方式定义的视图称为函数视图，函数视图便于理解；</li> <li>但是遇到一个视图对应的路径提供了多种不同HTTP请求方式的支持时，便需要在一个函数中编写不同的业务逻辑，代码可读性与复用性都不佳。</li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code> <span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">&quot;&quot;&quot;处理注册&quot;&quot;&quot;</span>
	<span class="token comment"># 获取请求方法，判断是GET/POST请求</span>
	<span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
		<span class="token comment"># 处理GET请求，返回注册页面</span>
		<span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'register.html'</span><span class="token punctuation">)</span>
	<span class="token keyword">else</span><span class="token punctuation">:</span>
		<span class="token comment"># 处理POST请求，实现注册逻辑</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'这里实现注册逻辑'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="3"><li>使用类视图可以将视图对应的不同请求方式以类中的不同方法来区别定义</li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>generic <span class="token keyword">import</span> View
<span class="token keyword">class</span> <span class="token class-name">RegisterView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">&quot;&quot;&quot;类视图：处理注册&quot;&quot;&quot;</span>
	<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token triple-quoted-string string">&quot;&quot;&quot;处理GET请求，返回注册页面&quot;&quot;&quot;</span>
		<span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'register.html'</span><span class="token punctuation">)</span>
	<span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token triple-quoted-string string">&quot;&quot;&quot;处理POST请求，实现注册逻辑&quot;&quot;&quot;</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'这里实现注册逻辑'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="4"><li>好处
<ul><li>代码可读性好</li> <li>类视图相对于函数视图有更高的复用性， 如果其他地方需要用到某个类视图的某个特定逻辑，直接继承该类视图即可</li></ul></li></ol> <h4 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h4> <ol><li>定义类视图需要继承自Django提供的父类View；</li> <li>可使用from django.views.generic import View或者from django.views.generic.base import View 导入，如上所示；</li> <li>配置路由时，使用类视图的as_view()方法来添加。</li></ol> <div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token comment"># 视图函数：注册</span>
	<span class="token comment"># url(r'^register/$', views.register, name='register'),</span>
	<span class="token comment"># 类视图：注册</span>
	url<span class="token punctuation">(</span><span class="token string">r'^register/$'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>RegisterView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'register'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h4> <div class="language-python line-numbers-mode"><pre class="language-python"><code> <span class="token decorator annotation punctuation">@classonlymethod</span>
<span class="token keyword">def</span> <span class="token function">as_view</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">**</span>initkwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Main entry point for a request-response process.
    &quot;&quot;&quot;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略代码<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">view</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self <span class="token operator">=</span> cls<span class="token punctuation">(</span><span class="token operator">**</span>initkwargs<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'head'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>head <span class="token operator">=</span> self<span class="token punctuation">.</span>get
        self<span class="token punctuation">.</span>request <span class="token operator">=</span> request
        self<span class="token punctuation">.</span>args <span class="token operator">=</span> args
        self<span class="token punctuation">.</span>kwargs <span class="token operator">=</span> kwargs
        <span class="token comment"># 调用dispatch方法，按照不同请求方式调用不同请求方法</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>dispatch<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>省略代码<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment"># 返回真正的函数视图</span>
    <span class="token keyword">return</span> view
<span class="token keyword">def</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Try to dispatch to the right method; if a method doesn't exist,</span>
    <span class="token comment"># defer to the error handler. Also defer to the error handler if the</span>
    <span class="token comment"># request method isn't on the approved list.</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>http_method_names<span class="token punctuation">:</span>
        handler <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">.</span>method<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>http_method_not_allowed<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        handler <span class="token operator">=</span> self<span class="token punctuation">.</span>http_method_not_allowed
    <span class="token keyword">return</span> handler<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><ul><li>调用流程 as_view--&gt;view--&gt;dispatch</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <h3 id="反射"><a href="#反射" class="header-anchor">#</a> <strong>反射</strong></h3> <p>它可以把字符串映射成变量或方法然后可以去执行调用、修改等操作，它有四个重要的方法：</p> <ol><li>getattr 获取指定字符串名称的对象属性</li> <li>setattr 为对象设置一个属性</li> <li>hasattr 判断对象是否有对应的对象（字符串）</li> <li>delattr 删除对象的属性</li></ol> <ul><li>attr是属性英文的前几个字母，属性指的是类中类变量、实例变量和方法。但是要注意不能是私有的，如果你的变量是以“_”开头，那将无法获取。</li> <li>getattr()函数的使用方法：接收2个参数，前面是一个类或者模块，后面是一个字符串！</li></ul> <h3 id="反射作用"><a href="#反射作用" class="header-anchor">#</a> 反射作用</h3> <p>考虑有这么一个场景：需要根据用户输入url的不同，调用不同的函数，实现不同的操作，也就是一个WEB框架的url路由功能。路由功能是web框架里的核心功能之一，例如Django的urls。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">import</span> commons 

<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    inp <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;请输入您想访问页面的url：  &quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    func <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>commons<span class="token punctuation">,</span> inp<span class="token punctuation">)</span>
    func<span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h3> <ol><li>View类的dispatch通过接收到的请求方法变为小写从而使用反射得到类中的相对应方法（参考上面原理模块的代码）</li> <li>settings配置中心和中间件使用反射</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>import importlib

# 获取到settings文件的路径
self.SETTINGS_MODULE = settings_module

# 通过importlib.import_module获取到settings文件对象
mod = importlib.import_module(self.SETTINGS_MODULE) 


# 循环获取到settings文件对象里面的属性
for setting in dir(mod):
    # 得到大写的属性名
    if setting.isupper():
    	# 得到属性值比如中间件等其他配置属性
    	setting_value = getattr(mod, setting)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></div> <h4 id="使用装饰器"><a href="#使用装饰器" class="header-anchor">#</a> 使用装饰器</h4> <p>为了理解方便，先来定义一个为函数视图准备的装饰器（在设计装饰器时基本都以函数视图作为考虑的被装饰对象），及一个要被装饰的类视图。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">my_decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'自定义装饰器被调用了'</span><span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'请求路径%s'</span> <span class="token operator">%</span> request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
		<span class="token keyword">return</span> func<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
	<span class="token keyword">return</span> wrapper
<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
	<span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ol><li>在URL配置中装饰<div class="language-python line-numbers-mode"><pre class="language-python"><code>urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    url<span class="token punctuation">(</span><span class="token string">r'^demo/$'</span><span class="token punctuation">,</span> my_decorate<span class="token punctuation">(</span>DemoView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>此种方式最简单，但因装饰行为被放置到了url配置中，单看视图的时候无法知道此视图还被添加了装饰器，不利于代码的完整性，不建议使用。</li> <li>此种方式会为类视图中的所有请求方法都加上装饰器行为（因为是在视图入口处，分发请求方式前）。</li></ul></li> <li>在类视图中装饰
<ul><li>在类视图中使用为函数视图准备的装饰器时，不能直接添加装饰器，需要使用method_decorator将其转换为适用于类视图方法的装饰器。</li> <li>method_decorator装饰器使用name参数指明被装饰的方法</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 为全部请求方法添加装饰器</span>
<span class="token decorator annotation punctuation">@method_decorator</span><span class="token punctuation">(</span>my_decorator<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'dispatch'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
	<span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token comment"># 为特定请求方法添加装饰器</span>
<span class="token decorator annotation punctuation">@method_decorator</span><span class="token punctuation">(</span>my_decorator<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'get'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
	<span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li> <li>如果需要为类视图的多个方法添加装饰器，但又不是所有的方法（为所有方法添加装饰器参考上面例子），可以直接在需要添加装饰器的方法上使用method_decorator<div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>decorators <span class="token keyword">import</span> method_decorator
<span class="token comment"># 为特定请求方法添加装饰器</span>
<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token decorator annotation punctuation">@method_decorator</span><span class="token punctuation">(</span>my_decorator<span class="token punctuation">)</span>  <span class="token comment"># 为get方法添加了装饰器</span>
	<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
	<span class="token decorator annotation punctuation">@method_decorator</span><span class="token punctuation">(</span>my_decorator<span class="token punctuation">)</span>  <span class="token comment"># 为post方法添加了装饰器</span>
	<span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
	<span class="token keyword">def</span> <span class="token function">put</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 没有为put方法添加装饰器</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'put方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li></ol> <h4 id="类视图mixin扩展类"><a href="#类视图mixin扩展类" class="header-anchor">#</a> 类视图Mixin扩展类</h4> <p>使用面向对象多继承的特性，可以通过定义父类（作为扩展类），在父类中定义想要向类视图补充的方法，类视图继承这些扩展父类，便可实现代码复用。定义的扩展父类名称通常以Mixin结尾</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MyDecoratorMixin</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token decorator annotation punctuation">@classmethod</span>
	<span class="token keyword">def</span> <span class="token function">as_view</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
		view <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
		view <span class="token operator">=</span> my_decorator<span class="token punctuation">(</span>view<span class="token punctuation">)</span>
		<span class="token keyword">return</span> view
<span class="token keyword">class</span> <span class="token class-name">DemoView</span><span class="token punctuation">(</span>MyDecoratorMixin<span class="token punctuation">,</span> View<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'get方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
	<span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'post方法'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">ListModelMixin</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">&quot;&quot;&quot;
	list扩展类
	&quot;&quot;&quot;</span>
	<span class="token keyword">def</span> <span class="token function">list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>	
<span class="token keyword">class</span> <span class="token class-name">CreateModelMixin</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">&quot;&quot;&quot;
	create扩展类
	&quot;&quot;&quot;</span>
	<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">class</span> <span class="token class-name">BooksView</span><span class="token punctuation">(</span>CreateModelMixin<span class="token punctuation">,</span> ListModelMixin<span class="token punctuation">,</span> View<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">&quot;&quot;&quot;
	同时继承两个扩展类，复用list和create方法
	&quot;&quot;&quot;</span>
	<span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		self<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		self<span class="token punctuation">.</span>create<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h3> <ol><li>Django中的中间件是一个轻量级、底层的插件系统，可以介入Django的请求和响应处理过程，修改Django的输入或输出</li> <li>中间件的设计为开发者提供了一种无侵入式的开发方式，增强了Django框架的健壮性。</li> <li>我们可以使用中间件，在Django处理视图的不同阶段对输入或输出进行干预。</li> <li>中间件的定义方法
<ul><li>定义一个中间件工厂函数，然后返回一个可以被调用的中间件。</li> <li>中间件工厂函数需要接收一个可以调用的get_response对象。</li> <li>返回的中间件也是一个可以被调用的对象，并且像视图一样需要接收一个request对象参数，返回一个response对象。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">simple_middleware</span><span class="token punctuation">(</span>get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 此处编写的代码仅在Django第一次配置和初始化的时候执行一次。</span>
	<span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token comment"># 此处编写的代码会在每个请求处理视图前被调用。</span>
		response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token comment"># 此处编写的代码会在每个请求处理视图之后被调用。</span>
		<span class="token keyword">return</span> response
	<span class="token keyword">return</span> middleware
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ol> <p>例如，在users应用中新建一个middleware.py文件</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">my_middleware</span><span class="token punctuation">(</span>get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'init 被调用'</span><span class="token punctuation">)</span>
	<span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'before request 被调用'</span><span class="token punctuation">)</span>
		response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'after response 被调用'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> response
	<span class="token keyword">return</span> middleware
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>定义好中间件后，需要在settings.py 文件中添加注册中间件</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'users.middleware.my_middleware'</span><span class="token punctuation">,</span>  <span class="token comment"># 添加中间件</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>定义一个视图进行测试</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">demo_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'view 视图被调用'</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>备注：Django运行在调试模式下，中间件init部分有可能被调用两次</li> <li>多个中间件的执行顺序
<ul><li>在请求视图被处理前，中间件由上至下依次执行</li> <li>在请求视图被处理后，中间件由下至上依次执行</li></ul></li> <li>定义两个中间件</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">my_middleware</span><span class="token punctuation">(</span>get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'init 被调用'</span><span class="token punctuation">)</span>
	<span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'before request 被调用'</span><span class="token punctuation">)</span>
		response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'after response 被调用'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> response
	<span class="token keyword">return</span> middleware

<span class="token keyword">def</span> <span class="token function">my_middleware2</span><span class="token punctuation">(</span>get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'init2 被调用'</span><span class="token punctuation">)</span>
	<span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'before request 2 被调用'</span><span class="token punctuation">)</span>
		response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
		<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'after response 2 被调用'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> response
	<span class="token keyword">return</span> middleware
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>注册添加两个中间件</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>MIDDLEWARE <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token string">'django.middleware.security.SecurityMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.contrib.sessions.middleware.SessionMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.middleware.common.CommonMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.middleware.csrf.CsrfViewMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.contrib.messages.middleware.MessageMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span><span class="token punctuation">,</span>
	<span class="token string">'users.middleware.my_middleware'</span><span class="token punctuation">,</span>  <span class="token comment"># 添加</span>
	<span class="token string">'users.middleware.my_middleware2'</span><span class="token punctuation">,</span>  <span class="token comment"># 添加</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>执行结果</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>init2 被调用
init 被调用
before request 被调用
before request <span class="token number">2</span> 被调用
view 视图被调用
after response <span class="token number">2</span> 被调用
after response 被调用
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="模板"><a href="#模板" class="header-anchor">#</a> 模板</h2> <h3 id="django自带模板"><a href="#django自带模板" class="header-anchor">#</a> Django自带模板</h3> <ol><li>配置
<ul><li>在工程中创建模板目录templates</li> <li>在settings.py配置文件中修改TEMPLATES配置项的DIRS值</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token punctuation">{</span>
		<span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.template.backends.django.DjangoTemplates'</span><span class="token punctuation">,</span>
		<span class="token string">'DIRS'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'templates'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 此处修改</span>
		<span class="token string">'APP_DIRS'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
		<span class="token string">'OPTIONS'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
			<span class="token string">'context_processors'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
				<span class="token string">'django.template.context_processors.debug'</span><span class="token punctuation">,</span>
				<span class="token string">'django.template.context_processors.request'</span><span class="token punctuation">,</span>
				<span class="token string">'django.contrib.auth.context_processors.auth'</span><span class="token punctuation">,</span>
				<span class="token string">'django.contrib.messages.context_processors.messages'</span><span class="token punctuation">,</span>
			<span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li>定义模板
<ul><li>在templates目录中新建一个模板文件，如index.html</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Title<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> city <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li>模板渲染
<ul><li>Django提供了一个函数render实现模板渲染</li> <li>render(request对象, 模板文件路径, 模板数据字典)</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	context<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'北京'</span><span class="token punctuation">}</span>
	<span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">'index.html'</span><span class="token punctuation">,</span>context<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li>模板语法
<ul><li>模板变量
<ul><li>变量名必须由字母、数字、下划线（不能以下划线开头）和点组成。</li> <li>语法：</li> <li>模板变量可以使python的内建类型，也可以是对象</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	context <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token string">'city'</span><span class="token punctuation">:</span> <span class="token string">'北京'</span><span class="token punctuation">,</span>
		<span class="token string">'adict'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
			<span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'西游记'</span><span class="token punctuation">,</span>
			<span class="token string">'author'</span><span class="token punctuation">:</span> <span class="token string">'吴承恩'</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string">'alist'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&lt;</span>!DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Title<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> city <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> adict <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> adict<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>  注意字典的取值方法
	<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> alist <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>  
	<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> alist<span class="token punctuation">.</span><span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>  注意列表的取值方法
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li> <li>模板语句
<ul><li>for循环</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> 列表 <span class="token operator">%</span><span class="token punctuation">}</span>
循环逻辑
<span class="token punctuation">{</span><span class="token punctuation">{</span>forloop<span class="token punctuation">.</span>counter<span class="token punctuation">}</span><span class="token punctuation">}</span>表示当前是第几次循环，从<span class="token number">1</span>开始
<span class="token punctuation">{</span><span class="token operator">%</span>empty<span class="token operator">%</span><span class="token punctuation">}</span> 列表为空或不存在时执行此逻辑
<span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>if条件</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">%</span><span class="token punctuation">}</span>
逻辑<span class="token number">1</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">elif</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token operator">%</span><span class="token punctuation">}</span>
逻辑<span class="token number">2</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">else</span> <span class="token operator">%</span><span class="token punctuation">}</span>
逻辑<span class="token number">3</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endif <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>比较运算符如：==、!=、&lt;、&gt;、&lt;=、&gt;=</li> <li>布尔运算符如：and、or、not</li> <li>运算符左右两侧不能紧挨变量或常量，必须有空格</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">%</span><span class="token punctuation">}</span>  <span class="token comment"># 正确</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">if</span> a<span class="token operator">==</span><span class="token number">1</span> <span class="token operator">%</span><span class="token punctuation">}</span>  <span class="token comment"># 错误</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul></li> <li>过滤器
<ul><li>使用管道符号|来应用过滤器，用于进行计算、转换操作，可以使用在变量、标签中。</li> <li>如果过滤器需要参数，则使用冒号:传递参数。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>变量|过滤器:参数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>列举几个自带过滤器
<ul><li>safe，禁用转义，告诉模板这个变量是安全的，可以解释执行</li> <li>length，长度，返回字符串包含字符的个数，或列表、元组、字典的元素个数。</li> <li>default，默认值，如果变量不存在时则返回默认值。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>data|default:'默认值'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>date，日期，用于对日期类型的值进行字符串格式化，常用的格式化字符如下
<ul><li>Y表示年，格式为4位，y表示两位的年。</li> <li>m表示月，格式为01,02,12等。</li> <li>d表示日, 格式为01,02等。</li> <li>j表示日，格式为1,2等。</li> <li>H表示时，24进制，h表示12进制的时。</li> <li>i表示分，为0-59。</li> <li>s表示秒，为0-59。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>value|date:&quot;Y年m月j日  H时i分s秒&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li>template提供的内置过滤器，不够用，不灵活，就可以自己定义一个过滤器
<ul><li>在自己的app里建一个templatetags包，在包里创建一个后面要在HTML文件引用的py文件，</li> <li>在py文件中，先导入from django import template ，</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>  实例化对象register <span class="token operator">=</span> template<span class="token punctuation">.</span>Library<span class="token punctuation">(</span><span class="token punctuation">)</span>
  创建一个template能认识的函数
  对创建的每一个过滤器，都要用加上装饰器
  
  <span class="token comment">#导入包</span>
  <span class="token keyword">from</span> django <span class="token keyword">import</span> template
  <span class="token comment">#实例化注册对象</span>
  register <span class="token operator">=</span> template<span class="token punctuation">.</span>Library<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">#使用装饰器自定义过滤器</span>
  <span class="token decorator annotation punctuation">@register<span class="token punctuation">.</span>filter</span>
  <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> x<span class="token operator">*</span>x
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>在HTML文件中引用
<ul><li>load templatetags</li> <li>使用过滤器</li></ul></li> <li>注意点: templatetags文件夹 要在各自的应用内创建</li></ul></li></ul></li> <li>模板继承
<ul><li>模板继承和类的继承含义是一样的，主要是为了提高代码重用，减轻开发人员的工作量</li> <li><strong>父模板</strong> <ul><li>如果发现在多个模板中某些内容相同，那就应该把这段内容定义到父模板中。</li> <li>标签block：用于在父模板中预留区域，留给子模板填充差异性的内容，名字不能相同。</li> <li>为了更好的可读性，建议给endblock标签写上名字，这个名字与对应的block名字相同。</li> <li>父模板中也可以使用上下文中传递过来的数据。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% block 名称 %}
预留区域，可以编写默认内容，也可以没有默认内容
{% endblock  名称 %}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><strong>子模板</strong> <ul><li>标签extends：继承，写在子模板文件的第一行</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% extends &quot;父模板路径&quot;%}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>子模版不用填充父模版中的所有预留区域，如果子模版没有填充，则使用父模版定义的默认值。</li> <li>填充父模板中指定名称的预留区域。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% block 名称 %}
实际填充内容
{{ block.super }}用于获取父模板中block的内容
{% endblock 名称 %}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ul></li> <li>注释
<ul><li>单行注释语法</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>{#...#}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>多行注释使用comment标签</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>{% comment %}
...
{% endcomment %}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ol> <h3 id="jinja模板"><a href="#jinja模板" class="header-anchor">#</a> Jinja模板</h3> <ol><li>Django中使用jinja2模板
<ul><li>jinja2介绍
<ul><li>是 Python 下一个被广泛应用的模板引擎，是由Python实现的模板语言</li> <li>他的设计思想来源于 Django 的模板引擎，并扩展了其语法和一系列强大的功能，尤其是Flask框架内置的模板语言</li> <li>由于django默认模板引擎功能不齐全,速度慢，所以我们也可以在Django中使用jinja2, jinja2宣称比django默认模板引擎快10-20倍。</li></ul></li> <li>安装jinja2模块</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>pip install jinja2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>Django配置jinja2</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>在项目文件中创建 jinja2_env<span class="token punctuation">.</span>py 文件
<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Environment
<span class="token keyword">def</span> <span class="token function">environment</span><span class="token punctuation">(</span><span class="token operator">**</span>options<span class="token punctuation">)</span><span class="token punctuation">:</span>
	env <span class="token operator">=</span> Environment<span class="token punctuation">(</span><span class="token operator">**</span>options<span class="token punctuation">)</span>
	<span class="token keyword">return</span> env
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>在settings.py文件</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>TEMPLATES <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token punctuation">{</span>
		<span class="token string">'BACKEND'</span><span class="token punctuation">:</span> <span class="token string">'django.template.backends.jinja2.Jinja2'</span><span class="token punctuation">,</span><span class="token comment">#修改1</span>
		<span class="token string">'DIRS'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">'templates'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">'APP_DIRS'</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">,</span>
		<span class="token string">'OPTIONS'</span><span class="token punctuation">:</span><span class="token punctuation">{</span>
			<span class="token string">'environment'</span><span class="token punctuation">:</span> <span class="token string">'jinja2_env.environment'</span><span class="token punctuation">,</span><span class="token comment"># 修改2</span>
			<span class="token string">'context_processors'</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
				<span class="token string">'django.template.context_processors.debug'</span><span class="token punctuation">,</span>
				<span class="token string">'django.template.context_processors.request'</span><span class="token punctuation">,</span>
				<span class="token string">'django.contrib.auth.context_processors.auth'</span><span class="token punctuation">,</span>
				<span class="token string">'django.contrib.messages.context_processors.messages'</span><span class="token punctuation">,</span>
			<span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>jinja2模板的使用绝大多数和Django自带模板一样
<ul><li>for循环有差异</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>loop.index 当前循环迭代次数（从1开始）
loop.index() 当前循环迭代次数（从0开始）
loop.reindex 到循环结束需要迭代次数（从1开始）
loop.reindex（） 到循环结束需要迭代次数（从0开始）
loop.first 如果是第一次迭代，为True
loop.last 如果是最后一次迭代，为True
loop.length 序列中的项目数
loop.cycle 在一串序列期间取值的辅助函数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li>jinja2自定义过滤器</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Environment
<span class="token keyword">def</span> <span class="token function">environment</span><span class="token punctuation">(</span><span class="token operator">**</span>options<span class="token punctuation">)</span><span class="token punctuation">:</span>
    env <span class="token operator">=</span> Environment<span class="token punctuation">(</span><span class="token operator">**</span>options<span class="token punctuation">)</span>
    <span class="token comment"># 2.将自定义的过滤器添加到 环境中</span>
    env<span class="token punctuation">.</span>filters<span class="token punctuation">[</span><span class="token string">'do_listreverse'</span><span class="token punctuation">]</span> <span class="token operator">=</span> do_listreverse
    <span class="token keyword">return</span> env
<span class="token comment"># 1.自定义过滤器</span>
<span class="token keyword">def</span> <span class="token function">do_listreverse</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> li <span class="token operator">==</span> <span class="token string">&quot;B&quot;</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;哈哈&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li>CSRF攻击
<ul><li>CSRF全拼为Cross Site Request Forgery，译为跨站请求伪造。</li> <li>CSRF指攻击者盗用了你的身份，以你的名义发送恶意请求。</li> <li>防止 CSRF 攻击
<ul><li>在客户端向后端请求界面数据的时候，后端会往响应中的 cookie 中设置 csrf_token 的值</li> <li>在 Form 表单中添加一个隐藏的的字段，值也是 csrf_token</li> <li>在用户点击提交的时候，会带上这两个值向后台发起请求</li> <li>后端接受到请求，以会以下几件事件：
<ul><li>从 cookie中取出 csrf_token</li> <li>从 表单数据中取出来隐藏的 csrf_token 的值</li> <li>进行对比</li></ul></li> <li>如果比较之后两值一样，那么代表是正常的请求，如果没取到或者比较不一样，代表不是正常的请求，不执行下一步操作</li></ul></li></ul></li></ol> <h2 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h2> <h3 id="orm框架"><a href="#orm框架" class="header-anchor">#</a> ORM框架</h3> <ul><li>O是object，也就类对象的意思，R是relation，翻译成中文是关系，也就是关系数据库中数据表的意思，M是mapping，是映射的意思。在ORM框架中，它帮我们把类和数据表进行了一个映射，可以让我们通过类和类对象就能操作它所对应的表格中的数据。ORM框架还有一个功能，它可以根据我们设计的类自动帮我们生成数据库中的表格，省去了我们自己建表的过程。</li> <li>django中内嵌了ORM框架，不需要直接面向数据库编程，而是定义模型类，通过模型类和对象完成数据表的增删改查操作。</li> <li>使用django进行数据库开发的步骤如下：
<ul><li>配置数据库连接信息</li> <li>在models.py中定义模型类</li> <li>迁移</li> <li>通过类和对象完成数据增删改查操作</li></ul></li></ul> <h3 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h3> <ul><li>在settings.py中保存了数据库的连接配置信息，Django默认初始配置使用sqlite数据库</li> <li>使用MySQL数据库首先需要安装驱动程序</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>pip install PyMySQL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在Django的工程同名子目录的__init__.py文件中添加如下语句</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> pymysql <span class="token keyword">import</span> install_as_MySQLdb
install_as_MySQLdb<span class="token punctuation">(</span><span class="token punctuation">)</span>
作用是让Django的ORM能以mysqldb的方式来调用PyMySQ
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>修改DATABASES配置信息</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>DATABASES <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
		<span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'django.db.backends.mysql'</span><span class="token punctuation">,</span>
		<span class="token string">'HOST'</span><span class="token punctuation">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库主机</span>
		<span class="token string">'PORT'</span><span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库端口</span>
		<span class="token string">'USER'</span><span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库用户名</span>
		<span class="token string">'PASSWORD'</span><span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库用户密码</span>
		<span class="token string">'NAME'</span><span class="token punctuation">:</span> <span class="token string">'django_demo'</span>  <span class="token comment"># 数据库名字</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在MySQL中创建数据库</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>create database django_demo default charset<span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="定义模型类"><a href="#定义模型类" class="header-anchor">#</a> 定义模型类</h3> <ul><li>模型类被定义在&quot;应用/models.py&quot;文件中。</li> <li>模型类必须继承自Model类，位于包django.db.models中。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>创建应用booktest，在models<span class="token punctuation">.</span>py 文件中定义模型类

<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models
<span class="token comment">#定义图书模型类BookInfo</span>
<span class="token keyword">class</span> <span class="token class-name">BookInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
	btitle <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'名称'</span><span class="token punctuation">)</span>
	bpub_date <span class="token operator">=</span> models<span class="token punctuation">.</span>DateField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">'发布日期'</span><span class="token punctuation">)</span>
	bread <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'阅读量'</span><span class="token punctuation">)</span>
	bcomment <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'评论量'</span><span class="token punctuation">)</span>
	is_delete <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'逻辑删除'</span><span class="token punctuation">)</span>
	<span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
		db_table <span class="token operator">=</span> <span class="token string">'tb_books'</span>  <span class="token comment"># 指明数据库表名</span>
		verbose_name <span class="token operator">=</span> <span class="token string">'图书'</span>  <span class="token comment"># 在admin站点中显示的名称</span>
		verbose_name_plural <span class="token operator">=</span> verbose_name  <span class="token comment"># 显示的复数名称</span>
	<span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token triple-quoted-string string">&quot;&quot;&quot;定义每个数据对象的显示信息&quot;&quot;&quot;</span>
		<span class="token keyword">return</span> self<span class="token punctuation">.</span>btitle
<span class="token comment">#定义英雄模型类HeroInfo</span>
<span class="token keyword">class</span> <span class="token class-name">HeroInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
	GENDER_CHOICES <span class="token operator">=</span> <span class="token punctuation">(</span>
		<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'female'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'male'</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span>
	hname <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'名称'</span><span class="token punctuation">)</span> 
	hgender <span class="token operator">=</span> models<span class="token punctuation">.</span>SmallIntegerField<span class="token punctuation">(</span>choices<span class="token operator">=</span>GENDER_CHOICES<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'性别'</span><span class="token punctuation">)</span>  
	hcomment <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'描述信息'</span><span class="token punctuation">)</span> 
	hbook <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>BookInfo<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'图书'</span><span class="token punctuation">)</span>
	is_delete <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">'逻辑删除'</span><span class="token punctuation">)</span>
	<span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
		db_table <span class="token operator">=</span> <span class="token string">'tb_heros'</span>
		verbose_name <span class="token operator">=</span> <span class="token string">'英雄'</span>
		verbose_name_plural <span class="token operator">=</span> verbose_name
	<span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> self<span class="token punctuation">.</span>hname
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li>数据库表名
<ul><li>模型类如果未指明表名，Django默认以 小写app应用名_小写模型类名 为数据库表名。</li> <li>可通过db_table 指明数据库表名。</li></ul></li> <li>关于主键
<ul><li>django会为表创建自动增长的主键列，每个模型只能有一个主键列，如果使用选项设置某属性为主键列后django不会再创建自动增长的主键列。</li> <li>默认创建的主键列属性为id，可以使用pk代替，pk全拼为primary key。</li></ul></li> <li>属性命名限制
<ul><li>不能是python的保留关键字。</li> <li>不允许使用连续的下划线，这是由django的查询方式决定的。</li> <li>定义属性时需要指定字段类型，通过字段类型的参数指定选项，语法如下：</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>属性=models.字段类型(选项)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li>字段类型
<ul><li>AutoField：自动增长的IntegerField，通常不用指定，不指定时Django会自动创建属性名为id的自动增长属性</li> <li>BooleanField：布尔字段，值为True或False</li> <li>NullBooleanField：支持Null、True、False三种值</li> <li>CharField：字符串，参数max_length表示最大字符个数</li> <li>TextField：大文本字段，一般超过4000个字符时使用</li> <li>IntegerField：整数，主键，它同AutoField一样，唯一的差别就是不自增</li> <li>SmallIntegerField：小整数时一般会用到</li> <li>DecimalField：十进制浮点数， 参数max_digits表示总位数， 参数decimal_places表示小数位数</li> <li>FloatField：浮点数</li> <li>DateField：日期， 参数auto_now表示每次保存对象时，自动设置该字段为当前时间，用于&quot;最后一次修改&quot;的时间戳，它总是使用当前日期，默认为False； 参数auto_now_add表示当对象第一次被创建时自动设置当前时间，用于创建的时间戳，它总是使用当前日期，默认为False; 参数auto_now_add和auto_now是相互排斥的，组合将会发生错误</li> <li>TimeField：时间，参数同DateField</li> <li>DateTimeField：日期时间，参数同DateField</li> <li>FileField：上传文件字段</li> <li>ImageField：继承于FileField，对上传的内容进行校验，确保是有效的图片</li> <li>ForeignKey：关系属性用法，建立一对多关系，<strong>ForeignKey('self', null=True, blank=True) 可以指向自己（不李姐，待研究）</strong></li></ul></li> <li>选项
<ul><li>null：如果为True，表示允许为空，默认值是False</li> <li>blank：如果为True，则该字段允许为空白，默认值是False</li> <li>db_column：字段的名称，如果未指定，则使用属性的名称</li> <li>db_index：若值为True, 则在表中会为此字段创建索引，默认值是False</li> <li>default：默认</li> <li>primary_key：若为True，则该字段会成为模型的主键字段，默认值是False，一般作为AutoField的选项使用</li> <li>related_name：指定外键的名称</li> <li>unique：如果为True, 这个字段在表中必须有唯一值，默认值是False</li> <li>verbose_name：用于指定名称</li> <li>choices：配置字段的choices后，在admin页面上就可以看到对应的选项展示，choice显示中文可以使用 &quot;get_字段名_display()&quot;</li> <li><strong>null是数据库范畴的概念，blank是表单验证范畴的</strong></li> <li><strong>当修改模型类之后，如果影响表结构，则必须重新做迁移，选项中default和blank不影响表结构</strong></li></ul></li> <li>外键
<ul><li>在设置外键时，需要通过on_delete选项指明主表删除数据时，对于外键引用表数据如何处理，在django.db.models中包含了可选常量：</li> <li>CASCADE 级联，删除主表数据时连通一起删除外键表中数据</li> <li>PROTECT 保护，通过抛出ProtectedError异常，来阻止删除主表中被外键应用的数据</li> <li>SET_NULL 设置为NULL，仅在该字段null=True允许为null时可用</li> <li>SET_DEFAULT 设置为默认值，仅在该字段设置了默认值时可用</li> <li>SET() 设置为特定值或者调用特定方法，如</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>auth <span class="token keyword">import</span> get_user_model
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models

<span class="token keyword">def</span> <span class="token function">get_sentinel_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">return</span> get_user_model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_or_create<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'deleted'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">MyModel</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
	user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>
		settings<span class="token punctuation">.</span>AUTH_USER_MODEL<span class="token punctuation">,</span>
		on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>SET<span class="token punctuation">(</span>get_sentinel_user<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div>DO_NOTHING 不做任何操作，如果数据库前置指明级联性，此选项会抛出IntegrityError异常</li></ul> <h3 id="迁移"><a href="#迁移" class="header-anchor">#</a> 迁移</h3> <p>生成迁移文件</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>python manage<span class="token punctuation">.</span>py makemigrations
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>同步到数据库中</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>python manage<span class="token punctuation">.</span>py migrate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="添加测试数据"><a href="#添加测试数据" class="header-anchor">#</a> 添加测试数据</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> tb_books<span class="token punctuation">(</span>btitle<span class="token punctuation">,</span>bpub_date<span class="token punctuation">,</span>bread<span class="token punctuation">,</span>bcomment<span class="token punctuation">,</span>is_delete<span class="token punctuation">)</span> <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'射雕英雄传'</span><span class="token punctuation">,</span><span class="token string">'1980-5-1'</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'天龙八部'</span><span class="token punctuation">,</span><span class="token string">'1986-7-24'</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'笑傲江湖'</span><span class="token punctuation">,</span><span class="token string">'1995-12-24'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'雪山飞狐'</span><span class="token punctuation">,</span><span class="token string">'1987-11-11'</span><span class="token punctuation">,</span><span class="token number">58</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> tb_heros<span class="token punctuation">(</span>hname<span class="token punctuation">,</span>hgender<span class="token punctuation">,</span>hbook_id<span class="token punctuation">,</span>hcomment<span class="token punctuation">,</span>is_delete<span class="token punctuation">)</span> <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token string">'郭靖'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'降龙十八掌'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'黄蓉'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'打狗棍法'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'黄药师'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'弹指神通'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'欧阳锋'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'蛤蟆功'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'梅超风'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'九阴白骨爪'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'乔峰'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'降龙十八掌'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'段誉'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'六脉神剑'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'虚竹'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'天山六阳掌'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'王语嫣'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'神仙姐姐'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'令狐冲'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'独孤九剑'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'任盈盈'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'弹琴'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'岳不群'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'华山剑法'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'东方不败'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'葵花宝典'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'胡斐'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'胡家刀法'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'苗若兰'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'黄衣'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'程灵素'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'医术'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token string">'袁紫衣'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token string">'六合拳'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="演示工具使用"><a href="#演示工具使用" class="header-anchor">#</a> 演示工具使用</h3> <ul><li>Django的manage工具提供了shell命令，帮助我们配置好当前工程的运行环境（如连接好数据库等），以便可以直接在终端中执行测试python语句</li> <li>通过如下命令进入shell</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>python manage<span class="token punctuation">.</span>py shell
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>导入两个模型类，以便后续使用</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> booktest<span class="token punctuation">.</span>models <span class="token keyword">import</span> BookInfo<span class="token punctuation">,</span> HeroInfo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="查看mysql数据库日志"><a href="#查看mysql数据库日志" class="header-anchor">#</a> 查看MySQL数据库日志</h3> <p>查看mysql数据库日志可以查看对数据库的操作记录。 mysql日志文件默认没有产生，需要做如下配置</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">vi</span> /etc/mysql/mysql.conf.d/mysqld.cnf
将general_log_file和general_log两处注释取消
<span class="token function">sudo</span> <span class="token function">service</span> mysql restart
<span class="token function">tail</span> -f /var/log/mysql/mysql.log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="数据库操作"><a href="#数据库操作" class="header-anchor">#</a> 数据库操作</h3> <h4 id="增加-2种方式"><a href="#增加-2种方式" class="header-anchor">#</a> 增加(2种方式)</h4> <ol><li>save<div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> datetime <span class="token keyword">import</span> date
book <span class="token operator">=</span> BookInfo<span class="token punctuation">(</span>
    btitle<span class="token operator">=</span><span class="token string">'西游记'</span><span class="token punctuation">,</span>
    bpub_date<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">1988</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    bread<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
    bcomment<span class="token operator">=</span><span class="token number">10</span>
<span class="token punctuation">)</span>
book<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
hero <span class="token operator">=</span> HeroInfo<span class="token punctuation">(</span>
    hname<span class="token operator">=</span><span class="token string">'孙悟空'</span><span class="token punctuation">,</span>
    hgender<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    hbook<span class="token operator">=</span>book
<span class="token punctuation">)</span>
hero<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
hero2 <span class="token operator">=</span> HeroInfo<span class="token punctuation">(</span>
    hname<span class="token operator">=</span><span class="token string">'猪八戒'</span><span class="token punctuation">,</span>
    hgender<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    hbook_id<span class="token operator">=</span>book<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token punctuation">)</span>
hero2<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li> <li>create<div class="language-python line-numbers-mode"><pre class="language-python"><code>HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
    hname<span class="token operator">=</span><span class="token string">'沙悟净'</span><span class="token punctuation">,</span>
    hgender<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    hbook<span class="token operator">=</span>book
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li>批量增加<div class="language-python line-numbers-mode"><pre class="language-python"><code>object_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'Alex'</span><span class="token punctuation">,</span>age<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'sss'</span><span class="token punctuation">,</span>age<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
<span class="token punctuation">]</span>
models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>bulk_create<span class="token punctuation">(</span>object_list<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment"># 每次10个批量添加</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ol> <h4 id="删除-2种方式"><a href="#删除-2种方式" class="header-anchor">#</a> 删除(2种方式)</h4> <ol><li>模型类对象delete<div class="language-python line-numbers-mode"><pre class="language-python"><code>hero <span class="token operator">=</span> HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">)</span>
hero<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li>模型类.objects.filter().delete()<div class="language-python line-numbers-mode"><pre class="language-python"><code>HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <h4 id="修改-2种方式"><a href="#修改-2种方式" class="header-anchor">#</a> 修改(2种方式)</h4> <ol><li>save<div class="language-python line-numbers-mode"><pre class="language-python"><code>修改模型类对象的属性，然后执行save<span class="token punctuation">(</span><span class="token punctuation">)</span>方法

hero <span class="token operator">=</span> HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>hname<span class="token operator">=</span><span class="token string">'猪八戒'</span><span class="token punctuation">)</span>
hero<span class="token punctuation">.</span>hname <span class="token operator">=</span> <span class="token string">'猪悟能'</span>
hero<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li>update<div class="language-python line-numbers-mode"><pre class="language-python"><code>使用模型类<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>，会返回受影响的行数

HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>hname<span class="token operator">=</span><span class="token string">'沙悟净'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>hname<span class="token operator">=</span><span class="token string">'沙僧'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>update_or_create()方法</li> <li>如果数据库内没有该数据则新增，如果有则更新。</li> <li>该方法的参数必须为一些用于查询的指定字段（这里是username），以及需要新增或者更新的defaults字典。</li> <li>而其返回值，则是一个查询对象和是否新建对象布尔值的二元元组。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">add_to_new_assets_zone</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    defaults <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'data'</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'username'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'password'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
models<span class="token punctuation">.</span>UserProfile<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>update_or_create<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'xiaohong'</span><span class="token punctuation">,</span> defaults<span class="token operator">=</span>defaults<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ol> <h4 id="查询"><a href="#查询" class="header-anchor">#</a> 查询</h4> <h5 id="基本查询"><a href="#基本查询" class="header-anchor">#</a> 基本查询</h5> <ul><li>get 查询单一结果，如果查到多条数据，则抛异常MultipleObjectsReturned；如果不存在会抛出模型类.DoesNotExist异常。</li> <li>all 查询多个结果。</li> <li>count 查询结果数量。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>QuerySet <span class="token punctuation">[</span><span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 射雕英雄传<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 天龙八部<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 笑傲江湖<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 雪山飞狐<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>BookInfo<span class="token punctuation">:</span> 西游记<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
book <span class="token operator">=</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>btitle<span class="token operator">=</span><span class="token string">'西游记'</span><span class="token punctuation">)</span>
book<span class="token punctuation">.</span><span class="token builtin">id</span>
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">#报错，没那么多数据		</span>
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="过滤查询"><a href="#过滤查询" class="header-anchor">#</a> 过滤查询</h5> <ul><li>filter 过滤满足条件的所有数据，查不到返回None</li> <li>exclude 排除掉符合条件剩下的结果</li> <li>get 过滤单一结果</li> <li>对于过滤条件的使用，上述三个方法相同，故仅以filter进行讲解</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>语法：
属性名称__比较运算符=值
# 属性名称和比较运算符间使用两个下划线，所以属性名不能包括多个下划线
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>相等
<ul><li>exact：表示判等</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__exact<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
可简写为：
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <h5 id="模糊查询"><a href="#模糊查询" class="header-anchor">#</a> 模糊查询</h5> <p>contains：是否包含，如果要包含%无需转义，直接写即可</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询书名包含<span class="token string">'传'</span>的图书。

BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>btitle__contains<span class="token operator">=</span><span class="token string">'传'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>startswith、endswith：以指定值开头或结尾</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询书名以<span class="token string">'部'</span>结尾的图书

BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>btitle__endswith<span class="token operator">=</span><span class="token string">'部'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>以上运算符都区分大小写，在这些运算符前加上i表示不区分大小写，如iexact、icontains、istartswith、iendswith</p> <h5 id="空查询"><a href="#空查询" class="header-anchor">#</a> 空查询</h5> <p>isnull：是否为null</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询书名不为空的图书。

BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>btitle__isnull<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="范围查询"><a href="#范围查询" class="header-anchor">#</a> 范围查询</h5> <p>in：是否包含在范围内。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>例：查询编号为<span class="token number">1</span>或<span class="token number">3</span>或<span class="token number">5</span>的图书
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__in<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="比较查询"><a href="#比较查询" class="header-anchor">#</a> 比较查询</h5> <ul><li>gt 大于 (greater then)</li> <li>gte 大于等于 (greater then equal)</li> <li>lt 小于 (less then)</li> <li>lte 小于等于 (less then equal)</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询编号大于<span class="token number">3</span>的图书

BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__gt<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>不等于的运算符，使用exclude()过滤器</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询编号不等于<span class="token number">3</span>的图书

BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>exclude<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="日期查询"><a href="#日期查询" class="header-anchor">#</a> 日期查询</h5> <p>year、month、day、week_day、hour、minute、second：对日期时间类型的属性进行运算</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询<span class="token number">1980</span>年发表的图书。
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bpub_date__year<span class="token operator">=</span><span class="token number">1980</span><span class="token punctuation">)</span>
查询<span class="token number">1980</span>年<span class="token number">1</span>月<span class="token number">1</span>日后发表的图书。
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bpub_date__gt<span class="token operator">=</span>date<span class="token punctuation">(</span><span class="token number">19</span>	<span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="f对象"><a href="#f对象" class="header-anchor">#</a> F对象</h5> <p>之前的查询都是对象的属性与常量值比较，<strong>两个属性怎么比较</strong>呢？ 答：使用F对象，被定义在django.db.models中。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>语法如下：
F<span class="token punctuation">(</span>属性名<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>查询阅读量大于等于评论量的图书。
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> F
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gte<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'bcomment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>可以在F对象上使用算数运算。
例：查询阅读量大于<span class="token number">2</span>倍评论量的图书。
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gt<span class="token operator">=</span>F<span class="token punctuation">(</span><span class="token string">'bcomment'</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="q对象"><a href="#q对象" class="header-anchor">#</a> Q对象</h5> <p>多个过滤器逐个调用表示逻辑与关系，同sql语句中where部分的and关键字</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询阅读量大于<span class="token number">20</span>，并且编号小于<span class="token number">3</span>的图书。
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>id__lt<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
或
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__lt<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果需要实现逻辑或or的查询，需要使用Q()对象结合|运算符，Q对象被义在django.db.models</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>语法如下：
Q<span class="token punctuation">(</span>属性名__运算符<span class="token operator">=</span>值<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>查询阅读量大于<span class="token number">20</span>的图书，改写为Q对象如下。
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Q
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Q<span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Q对象可以使用&amp;、|连接，&amp;表示逻辑与，|表示逻辑或。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询阅读量大于<span class="token number">20</span>，或编号小于<span class="token number">3</span>的图书，只能使用Q对象实现
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Q<span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">|</span> Q<span class="token punctuation">(</span>pk__lt<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Q对象前可以使用~操作符，表示非not。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询编号不等于<span class="token number">3</span>的图书。
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token operator">~</span>Q<span class="token punctuation">(</span>pk<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="聚合函数"><a href="#聚合函数" class="header-anchor">#</a> 聚合函数</h5> <p>使用aggregate()过滤器调用聚合函数。聚合函数包括：Avg 平均，Count 数量，Max 最大，Min 最小，Sum 求和，被定义在django.db.models中</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>查询图书的总阅读量。
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Sum
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>Sum<span class="token punctuation">(</span><span class="token string">'bread'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
注意aggregate的返回值是一个字典类型，格式如下：
<span class="token punctuation">{</span><span class="token string">'属性名__聚合类小写'</span><span class="token punctuation">:</span>值<span class="token punctuation">}</span>
如<span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">'bread__sum'</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">}</span>

使用count时一般不使用aggregate<span class="token punctuation">(</span><span class="token punctuation">)</span>过滤器
查询图书总数。
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
注意count函数的返回值是一个数字。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h5> <div class="language-python line-numbers-mode"><pre class="language-python"><code>使用order_by对结果进行排序

BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'bread'</span><span class="token punctuation">)</span>  <span class="token comment"># 升序</span>
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'-bread'</span><span class="token punctuation">)</span>  <span class="token comment"># 降序</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="模型类关系-李姐不深刻"><a href="#模型类关系-李姐不深刻" class="header-anchor">#</a> <strong>模型类关系（李姐不深刻）</strong></h5> <ul><li>一对多关系(ForeignKey) ，将字段定义在多的一端</li> <li>多对多关系(ManyToManyField)，将字段定义在任意一端</li> <li>一对一关系(OneToOneField)，将字段定义在任意一端</li> <li>自关联，自关联是一种特殊的一对多（把关联属性指向了自己），案例：显示多级地区</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>models<span class="token punctuation">.</span>py

<span class="token keyword">class</span> <span class="token class-name">AreaInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">'''地区模型类'''</span>
	<span class="token comment"># 地区名称</span>
	atitle <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
	<span class="token comment"># 关系属性，代表当前地区的父级地区,主键指向自己，允许为空</span>
	aParent <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'self'</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>views<span class="token punctuation">.</span>py

<span class="token keyword">from</span> booktest<span class="token punctuation">.</span>models <span class="token keyword">import</span> AreaInfo
<span class="token keyword">def</span> <span class="token function">areas</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">'''获取广州市的上级地区和下级地图'''</span>
	<span class="token comment"># 1.获取广州市信息</span>
	area <span class="token operator">=</span> AreaInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span>atitle<span class="token operator">=</span><span class="token string">'广州市'</span><span class="token punctuation">)</span>
	<span class="token comment"># 2.查询广州市的上级地区</span>
	parent <span class="token operator">=</span> area<span class="token punctuation">.</span>aParent
	<span class="token comment"># 3.查询广州市的下级地区</span>
	children <span class="token operator">=</span> area<span class="token punctuation">.</span>areainfo_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="关联查询"><a href="#关联查询" class="header-anchor">#</a> 关联查询</h5> <p>由一到多的访问语法</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>方法一：
一类的对象<span class="token punctuation">.</span>多类名小写_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
b<span class="token punctuation">.</span>heroinfo_set<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>方法二：
多类名<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>关联属性__一类属性名__条件名<span class="token punctuation">)</span>
models<span class="token punctuation">.</span>Article<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user__username<span class="token operator">=</span><span class="token string">'admin'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>由多到一的访问语法</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>方法一：
多类的对象<span class="token punctuation">.</span>主键
h <span class="token operator">=</span> HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
h<span class="token punctuation">.</span>hbook
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>方法二：
一类名<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>多类名小写__多类属性名<span class="token punctuation">)</span>
models<span class="token punctuation">.</span>UserProfile<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>article__title<span class="token operator">=</span><span class="token string">'啦啦啦我是3'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>访问一对应的模型类关联对象的id语法</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>多对应的模型类对象<span class="token punctuation">.</span>关联类属性_id
h <span class="token operator">=</span> HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
h<span class="token punctuation">.</span>hbook_id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>通过模型类实现关联查询时，要查哪个表中的数据，就需要通过哪个类来查；</li> <li>写关联查询条件的时候，如果类中没有关系属性，条件需要些对应类的名，如果类中有关系属性，直接写关系属性。</li></ul> <h5 id="关联过滤查询"><a href="#关联过滤查询" class="header-anchor">#</a> 关联过滤查询</h5> <p>由多模型类条件查询一模型类数据:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>语法如下：
关联模型类名小写__属性名__条件运算符<span class="token operator">=</span>值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>注意：如果没有&quot;__运算符&quot;部分，表示等于。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>例：查询图书，要求图书英雄为<span class="token string">&quot;孙悟空&quot;</span>
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>heroinfo__hname<span class="token operator">=</span><span class="token string">'孙悟空'</span><span class="token punctuation">)</span>
查询图书，要求图书中英雄的描述包含<span class="token string">&quot;八&quot;</span>
BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>heroinfo__hcomment__contains<span class="token operator">=</span><span class="token string">'八'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>由一模型类条件查询多模型类数据:</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>语法如下：
一模型类关联属性名__一模型类属性名__条件运算符<span class="token operator">=</span>值
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>注意：如果没有&quot;__运算符&quot;部分，表示等于。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>例：查询书名为“天龙八部”的所有英雄。
HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>hbook__btitle<span class="token operator">=</span><span class="token string">'天龙八部'</span><span class="token punctuation">)</span>
查询图书阅读量大于<span class="token number">30</span>的所有英雄
HeroInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>hbook__bread__gt<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="查询集-queryset"><a href="#查询集-queryset" class="header-anchor">#</a> 查询集 QuerySet</h4> <ol><li>概念
<ul><li>Django的ORM中存在查询集的概念。</li> <li>查询集，也称查询结果集、QuerySet，表示从数据库中获取的对象集合。</li> <li>当调用如下过滤器方法时，Django会返回查询集（而不是简单的列表）：
<ul><li>all()：返回所有数据。</li> <li>filter()：返回满足条件的数据。</li> <li>exclude()：返回满足条件之外的数据。</li> <li>order_by()：对结果进行排序。</li></ul></li> <li>对查询集可以再次调用过滤器进行过滤，如</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>bread__gt<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'bpub_date'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>也就意味着查询集可以含有零个、一个或多个过滤器。过滤器基于所给的参数限制查询的结果。</li> <li>从SQL的角度讲，查询集与select语句等价，过滤器像where、limit、order by子句。</li> <li>判断某一个查询集中是否有数据：</li> <li>exists()：判断查询集中是否有数据，如果有则返回True，没有则返回False。</li></ul></li> <li>两大特性
<ul><li>惰性执行
创建查询集不会访问数据库，直到调用数据时，才会访问数据库，调用数据的情况包括迭代、序列化、与if合用</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>例如，当执行如下语句时，并未进行数据库查询，只是创建了一个查询集qs
qs = BookInfo.objects.all()
继续执行遍历迭代操作后，才真正的进行了数据库的查询
for book in qs:
    print(book.btitle)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>缓存
使用同一个查询集，第一次使用时会发生数据库的查询，然后Django会把结果缓存下来，再次使用这个查询集时会使用缓存的数据，减少了数据库的查询次数。</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>情况一：如下是两个查询集，无法重用缓存，每次查询都会与数据库进行一次交互，增加了数据库的负载。
from booktest.models import BookInfo
[book.id for book in BookInfo.objects.all()]
[book.id for book in BookInfo.objects.all()]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>情况二：经过存储后，可以重用查询集，第二次使用缓存中的数据。

qs=BookInfo.objects.all()
[book.id for book in qs]
[book.id for book in qs]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li>限制查询集
<ul><li>可以对查询集进行取下标或切片操作，等同于sql中的limit和offset子句。</li> <li>注意：不支持负数索引。</li> <li>对查询集进行切片后返回一个新的查询集，不会立即执行查询。</li> <li>如果获取一个对象，直接使用[0]，等同于[0:1].get()，但是如果没有数据，[0]引发IndexError异常，[0:1].get()如果没有数据引发DoesNotExist异常。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>示例：获取第<span class="token number">1</span>、<span class="token number">2</span>项，运行查看。
qs <span class="token operator">=</span> BookInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol> <h4 id="管理器manager"><a href="#管理器manager" class="header-anchor">#</a> 管理器Manager</h4> <ul><li>管理器是Django的模型进行数据库操作的接口，Django应用的每个模型类都拥有至少一个管理器。</li> <li>我们在通过模型类的objects属性提供的方法操作数据库时，即是在使用一个管理器对象objects。当没有为模型类定义管理器时，Django会为每一个模型类生成一个名为objects的管理器，它是models.Manager类的对象。</li> <li>我们可以自定义管理器，继承自models.Manager，并应用到我们的模型类上。</li> <li>注意：一旦为模型类指明自定义的过滤器后，Django不再生成默认管理对象objects。</li> <li>自定义管理器类主要用于两种情况：
<ul><li>修改原始查询集，重写all()方法</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>打开booktest<span class="token operator">/</span>models<span class="token punctuation">.</span>py文件，定义类BookInfoManager

<span class="token comment">#图书管理器</span>
<span class="token keyword">class</span> <span class="token class-name">BookInfoManager</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Manager<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">all</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#默认查询未删除的图书信息</span>
        <span class="token comment">#调用父类的成员语法为：super().方法名</span>
        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>is_delete<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>在模型类BookInfo中定义管理器

<span class="token keyword">class</span> <span class="token class-name">BookInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    books <span class="token operator">=</span> BookInfoManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>使用方法

BookInfo.books.all()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div>在管理器类中补充定义新的方法<div class="language-python line-numbers-mode"><pre class="language-python"><code>打开booktest<span class="token operator">/</span>models<span class="token punctuation">.</span>py文件，定义方法create。
<span class="token keyword">class</span> <span class="token class-name">BookInfoManager</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Manager<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#创建模型类，接收参数为属性赋值</span>
    <span class="token keyword">def</span> <span class="token function">create_book</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> title<span class="token punctuation">,</span> pub_date<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#创建模型类对象self.model可以获得模型类</span>
        book <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token punctuation">)</span>
        book<span class="token punctuation">.</span>btitle <span class="token operator">=</span> title
        book<span class="token punctuation">.</span>bpub_date <span class="token operator">=</span> pub_date
        book<span class="token punctuation">.</span>bread<span class="token operator">=</span><span class="token number">0</span>
        book<span class="token punctuation">.</span>bcommet<span class="token operator">=</span><span class="token number">0</span>
        book<span class="token punctuation">.</span>is_delete <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token comment"># 将数据插入进数据表</span>
        book<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> book
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>为模型类BookInfo定义管理器books语法如下
class BookInfo(models.Model):
      ...
    books = BookInfoManager()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>调用语法如下：
book=BookInfo.books.create_book(&quot;abc&quot;,date(1980,1,1))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul> <h4 id="元信息"><a href="#元信息" class="header-anchor">#</a> 元信息</h4> <p>在模型类中定义类Meta，用于设置元信息，如使用db_table自定义表的名字</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">BookInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span>
		db_table<span class="token operator">=</span><span class="token string">'bookinfo'</span> <span class="token comment">#指定BookInfo生成的数据表名为bookinfo</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h4> <ul><li>Django中对于数据库的事务，默认每执行一句数据库操作，便会自动提交。我们需要在保存订单中自己控制数据库事务的执行流程。</li> <li>在Django中可以通过django.db.transaction模块提供的atomic来定义一个事务</li></ul> <h5 id="悲观锁"><a href="#悲观锁" class="header-anchor">#</a> 悲观锁</h5> <p>如Nginx的重复转发或者客户端的连续点击，造成了同样的接口在极短时间内被调用两次，数据库中出现了重复记录。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>generic <span class="token keyword">import</span> View
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> transaction
<span class="token keyword">from</span> 应用名<span class="token punctuation">.</span>models <span class="token keyword">import</span> 模型类名
<span class="token comment"># 类视图 (并发，悲观锁)</span>
<span class="token keyword">class</span> <span class="token class-name">MyView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@transaction<span class="token punctuation">.</span>atomic</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># select * from 表名 where id=1 for update;  </span>
        <span class="token comment"># for update 就表示锁,只有获取到锁才会执行查询,否则阻塞等待。</span>
        obj <span class="token operator">=</span> 模型类名<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>select_for_update<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 等事务提交后，会自动释放锁。</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>

    <span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> IntegrityError<span class="token punctuation">,</span> transaction
    <span class="token comment"># 这个例子中，即使generate_relationships()中的代码打破了数据完整性约束，你仍然可以在add_children()中执行数据库操作，并且create_parent()产生的更改也有效。需要注意的是，在调用handle_exception()之前，generate_relationships()中的修改就已经被安全的回滚了。因此，如果有需要，你照样可以在异常处理函数中操作数据库。</span>
    <span class="token decorator annotation punctuation">@transaction<span class="token punctuation">.</span>atomic</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        create_parent<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> transaction<span class="token punctuation">.</span>atomic<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                generate_relationships<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> IntegrityError<span class="token punctuation">:</span>
            handle_exception<span class="token punctuation">(</span><span class="token punctuation">)</span>
        add_children<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 此方法事务管理代码</span>
        进入最外层atomic代码块时开启一个事务；
        进入内部atomic代码块时创建保存点；
        退出内部atomic时释放或回滚事务；注意如果有嵌套，内层的事务也是不会提交的，可以释放（正常结束）或者回滚
        退出最外层atomic代码块时提交或者回滚事务；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h5 id="乐观锁"><a href="#乐观锁" class="header-anchor">#</a> 乐观锁</h5> <ul><li>乐观锁其实并不是真的上锁。而是通过SQL的where子句中的条件是否满足来判断是否满足更新条件来更新数据库，通过受影响行数判断是否更新成功，如果更新失败可以再次进行尝试，如果多次尝试失败就返回更新失败的结果。</li> <li>使用乐观锁时，必须设置数据库的隔离级别是Read Committed(读取已提交内容，可以读到其他线程已提交的数据)。如果隔离级别是Repeatable Read(可重复读，读到的数据都是开启事务时刻的数据，即使其他线程提交更新数据，该线程读取的数据也是之前读到的数据)，乐观锁如果第一次尝试失败，那么不管尝试多少次都会失败。 (Mysql数据库的默认隔离级别是Repeatable Read，需要修改成Read Committed)。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> JsonResponse
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>generic <span class="token keyword">import</span> View
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> transaction
<span class="token keyword">from</span> 应用名<span class="token punctuation">.</span>models <span class="token keyword">import</span> GoodsSKU

<span class="token comment"># 类视图 (并发，乐观锁)</span>
<span class="token keyword">class</span> <span class="token class-name">MyView</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@transaction<span class="token punctuation">.</span>atomic</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''订单创建'''</span>
        count <span class="token operator">=</span> <span class="token number">3</span>   <span class="token comment"># 订购3件商品</span>
        <span class="token comment"># 设置事务保存点</span>
        s1 <span class="token operator">=</span> transaction<span class="token punctuation">.</span>savepoint<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 乐观锁，最多尝试5次</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 查询商品的信息(库存)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                sku <span class="token operator">=</span> GoodsSKU<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token comment"># 商品不存在</span>
                transaction<span class="token punctuation">.</span>savepoint_rollback<span class="token punctuation">(</span>s1<span class="token punctuation">)</span>
                <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'res'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'errmsg'</span><span class="token punctuation">:</span> <span class="token string">'商品不存在'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment"># 判断商品的库存</span>
            <span class="token keyword">if</span> count <span class="token operator">&gt;</span> sku<span class="token punctuation">.</span>stock<span class="token punctuation">:</span>
                transaction<span class="token punctuation">.</span>savepoint_rollback<span class="token punctuation">(</span>s1<span class="token punctuation">)</span>
                <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'res'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'errmsg'</span><span class="token punctuation">:</span> <span class="token string">'商品库存不足'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment"># 更新商品的库存和销量</span>
            orgin_stock <span class="token operator">=</span> sku<span class="token punctuation">.</span>stock   <span class="token comment"># 原库存 (数据库隔离级别必须是Read Committed；如果是Repeatable Read,那么多次尝试读取的原库存都是一样的,读不到其他线程提交更新后的数据。)</span>
            new_stock <span class="token operator">=</span> orgin_stock <span class="token operator">-</span> count   <span class="token comment"># 更新后的库存</span>
            new_sales <span class="token operator">=</span> sku<span class="token punctuation">.</span>sales <span class="token operator">+</span> count   <span class="token comment"># 更新后的销量</span>
            <span class="token comment"># update 商品表 set stock=new_stock, sales=new_sales where id=1 and stock = orgin_stock</span>
            <span class="token comment"># 通过where子句中的条件判断库存是否进行了修改。(并发，乐观锁)</span>
            <span class="token comment"># 返回受影响的行数</span>
            res <span class="token operator">=</span> GoodsSKU<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> stock<span class="token operator">=</span>orgin_stock<span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>stock<span class="token operator">=</span>new_stock<span class="token punctuation">,</span> sales<span class="token operator">=</span>new_sales<span class="token punctuation">)</span>
            <span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 如果修改失败</span>
                <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
                    <span class="token comment"># 如果尝试5次都失败</span>
                    transaction<span class="token punctuation">.</span>savepoint_rollback<span class="token punctuation">(</span>s1<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'res'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'errmsg'</span><span class="token punctuation">:</span> <span class="token string">'下单失败'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>  <span class="token comment"># 再次尝试</span>
            <span class="token comment"># 否则更新成功</span>
            <span class="token comment"># 跳出尝试循环</span>
            <span class="token keyword">break</span>
        <span class="token comment"># 提交事务</span>
        transaction<span class="token punctuation">.</span>savepoint_commit<span class="token punctuation">(</span>s1<span class="token punctuation">)</span>
        <span class="token comment"># 返回应答</span>
        <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'res'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token string">'创建成功'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
在Django中，还提供了保存点的支持，可以在事务中创建保存点来记录数据的特定状态，数据库出现错误时，可以恢复到数据保存点的状态
<span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> transaction
<span class="token comment"># 创建保存点</span>
save_id <span class="token operator">=</span> transaction<span class="token punctuation">.</span>savepoint<span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token comment"># 回滚到保存点</span>
transaction<span class="token punctuation">.</span>savepoint_rollback<span class="token punctuation">(</span>save_id<span class="token punctuation">)</span>
<span class="token comment"># 提交从保存点到当前状态的所有数据库事务操作</span>
transaction<span class="token punctuation">.</span>savepoint_commit<span class="token punctuation">(</span>save_id<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h5 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h5> <p>在并发比较少时建议使用乐观锁，减少加锁、释放锁的开销。在并发比较高的时候，建议使用悲观锁。如果乐观锁多次尝试的代价比较大，也建议使用悲观锁。</p> <h2 id="asgi"><a href="#asgi" class="header-anchor">#</a> ASGI</h2> <h3 id="web应用程序和web服务器"><a href="#web应用程序和web服务器" class="header-anchor">#</a> Web应用程序和web服务器</h3> <ol><li>Web应用程序（Web）是一种能完成web业务逻辑，能让用户基于web浏览器访问的应用程序，它可以是一个实现http请求和响应功能的函数或者类，也可以是Django、Flask、sanic等这样的web框架，当然也可以是其他语言的web程序或web框架。</li> <li>Web服务器（Web Server）是一种运行于网站后台（物理服务器）的软件。Web服务器主要用于提供网页浏览或文件下载服务，它可以向浏览器等Web客户端提供html网页文档，也可以提供其他类型的可展示文档，让客户端用户浏览；还可以提供数据文件下载等。目前世界上最主流的Web服务器有 Nginx 、Apache、IIS、tomcat。</li> <li>Web服务器和Web应用程序的区别
<ul><li>Web应用程序主要是完成web应用的业务逻辑的处理，Web服务器则主要是应对外部请求的接收、响应和转发。</li> <li>web服务器启动运行，web应用程序才能被用户访问到。</li> <li>django框架中，我们之所以只有一个web应用程序就跑起来了，是因为我们在终端执行了一个命令，python manage.py runserver。这个命令启动了django框架中内置提供的测试web服务器。</li></ul></li></ol> <h3 id="网关接口"><a href="#网关接口" class="header-anchor">#</a> 网关接口</h3> <p>网关接口（Gateway Interface，GI）就是一种为了实现加载动态脚本而运行在Web服务器和Web应用程序中的通信接口，也可以理解为一份协议/规范。只有Web服务器和Web应用程序都实现了网关接口规范以后，双方的通信才能顺利完成。常见的网关接口协议：CGI，FastCGI，WSGI，ASGI。
<img src="/assets/img/uTools_1655646272034.b395ef15.png" alt=""></p> <ol><li>CGI（Common Gateway Inteface）通用网关接口，是外部应用程序与Web服务器之间的接口标准。FastCGI: CGI的一个扩展， 提升了性能，废除了 CGI fork-and-execute （来一个请求 fork 一个新进程处理，处理完再把进程 kill 掉）的工作方式，转而使用一种长生存期的方法，减少了进程消耗，提升了性能。这里 FastCGI 就应用于前端 server（nginx）与后端 server（uWSGI）的通信中，制定规范等等，让前后端服务器可以顺利理解双方都在说什么（当然 uWSGI 本身并不用 FastCGI, 它有另外的协议）</li> <li>WSGI（Python Web Server GateWay Interface），它是用在python web框架编写的应用程序与后端服务器之间的规范（如Django和uWSGI之间），让你写的应用程序可以与后端服务器顺利通信。WSGI就是一种统一规范， 所有使用WSGI的服务器都可以运行使用WSGI规范的web框架。</li> <li>WSGI和ASGI，都是基于Python设计的网关接口（Gateway Interface，GI）。</li> <li>Web服务器网关接口（Python Web Server Gateway Interface，WSGI），是Python为了解决Web服务器端与客户端之间的通信基于CGI标准而设计的。实现了WSGI协议的web服务器有：uWSGI、uvicorn、gunicorn。</li></ol> <h3 id="为什么有asgi的出现"><a href="#为什么有asgi的出现" class="header-anchor">#</a> 为什么有ASGI的出现</h3> <p>如果我们对WSGI非常满意的话，为什么还要提出ASGI呢？如果仔细检查网络请求的整个处理流程，那么答案就非常明显了。您可以查看 在Django中网络请求如何工作的动画。请注意，在数据库查询之后且响应发送之前，框架是如何等待的。这就是同步处理的缺点。其实网络服务器根本不应该去等待I/O活动。换言之，它应该切换为处理其他请求，并在较慢的活动完成时能得到通知。因此基于异步事件的架构是解决多种并发问题的正确方法</p> <h3 id="asgi的使用"><a href="#asgi的使用" class="header-anchor">#</a> ASGI的使用</h3> <p>A指的是Async，异步的意思。</p> <table><thead><tr><th>协议，规范</th> <th style="text-align:center;">支持的请求协议（常见，未列全）</th> <th style="text-align:right;">同步/异步</th> <th style="text-align:right;">支持的框架</th></tr></thead> <tbody><tr><td>CGI</td> <td style="text-align:center;">HTTP</td> <td style="text-align:right;"></td> <td style="text-align:right;">CGI程序</td></tr> <tr><td>WSGI</td> <td style="text-align:center;">HTTP</td> <td style="text-align:right;">同步</td> <td style="text-align:right;">django3.0以前，Flask1.0</td></tr> <tr><td>ASGI</td> <td style="text-align:center;">HTTP，HTTP2，WebSocket等</td> <td style="text-align:right;">同步/异步</td> <td style="text-align:right;">FastAPI，Quart，Sanic，Tornado，django3.0以后，flask2.0</td></tr></tbody></table> <h3 id=""><a href="#" class="header-anchor">#</a></h3> <h2 id="admin站点"><a href="#admin站点" class="header-anchor">#</a> admin站点</h2> <h3 id="使用admin站点"><a href="#使用admin站点" class="header-anchor">#</a> 使用Admin站点</h3> <ul><li>假设我们要设计一个新闻网站，我们需要编写展示给用户的页面，网页上展示的新闻信息是从哪里来的呢？是从数据库中查找到新闻的信息，然后把它展示在页面上。但是我们的网站上的新闻每天都要更新，这就意味着对数据库的增、删、改、查操作，那么我们需要每天写sql语句操作数据库吗? 如果这样的话，是不是非常繁琐，所以我们可以设计一个页面，通过对这个页面的操作来实现对新闻数据库的增删改查操作。那么问题来了，老板说我们需要在建立一个新网站，是不是还要设计一个页面来实现对新网站数据库的增删改查操作，但是这样的页面具有一个很大的重复性，那有没有一种方法能够让我们很快的生成管理数据库表的页面呢？有，那就是我们接下来要给大家讲的Django的后台管理。Django能够根据定义的模型类自动地生成管理页面。</li> <li>管理界面本地化</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>在settings<span class="token punctuation">.</span>py中设置语言和时区
LANGUAGE_CODE <span class="token operator">=</span> <span class="token string">'zh-hans'</span> <span class="token comment"># 使用中国语言</span>
TIME_ZONE <span class="token operator">=</span> <span class="token string">'Asia/Shanghai'</span> <span class="token comment"># 使用中国上海时间</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>创建管理员</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>创建管理员的命令如下，按提示输入用户名、邮箱、密码。
python manage<span class="token punctuation">.</span>py createsuperuser
打开浏览器，在地址栏中输入如下地址后回车。
http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>admin<span class="token operator">/</span>
输入前面创建的用户名、密码完成登录。
如果想要修改密码可以执行
python manage<span class="token punctuation">.</span>py changepassword 用户名
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>App应用配置
<ul><li>在每个应用目录中都包含了apps.py文件，用于保存该应用的相关信息。</li> <li>在创建应用时，Django会向apps.py文件中写入一个该应用的配置类，如</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>apps <span class="token keyword">import</span> AppConfig
<span class="token keyword">class</span> <span class="token class-name">BooktestConfig</span><span class="token punctuation">(</span>AppConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'booktest'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>我们将此类添加到工程settings.py中的INSTALLED_APPS列表中，表明注册安装具备此配置属性的应用
<ul><li>AppConfig.name 属性表示这个配置类是加载到哪个应用的，每个配置类必须包含此属性，默认自动生成。</li> <li>AppConfig.verbose_name 属性用于设置该应用的直观可读的名字，此名字在Django提供的Admin管理站点中会显示，如</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">from</span> django<span class="token punctuation">.</span>apps <span class="token keyword">import</span> AppConfig

<span class="token keyword">class</span> <span class="token class-name">BooktestConfig</span><span class="token punctuation">(</span>AppConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'booktest'</span>
    verbose_name <span class="token operator">=</span> <span class="token string">'图书管理'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul></li> <li>注册模型类
登录后台管理后，默认没有我们创建的应用中定义的模型类，需要在自己应用中的admin.py文件中注册，才可以在后台管理中看到，并进行增删改查操作。<div class="language-python line-numbers-mode"><pre class="language-python"><code>打开booktest<span class="token operator">/</span>admin<span class="token punctuation">.</span>py文件，编写如下代码：

<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
<span class="token keyword">from</span> booktest<span class="token punctuation">.</span>models <span class="token keyword">import</span> BookInfo<span class="token punctuation">,</span>HeroInfo
admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>BookInfo<span class="token punctuation">)</span>
admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>HeroInfo<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li>调整站点信息
<ul><li>admin.site.site_header 设置网站页头</li> <li>admin.site.site_title 设置页面标题</li> <li>admin.site.index_title 设置首页标语</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>在booktest<span class="token operator">/</span>admin<span class="token punctuation">.</span>py文件中添加一下信息
<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin
admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>site_header <span class="token operator">=</span> <span class="token string">'传智书城'</span>
admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>site_title <span class="token operator">=</span> <span class="token string">'传智书城MIS'</span>
admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>index_title <span class="token operator">=</span> <span class="token string">'欢迎使用传智书城MIS'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <h3 id="调整列表页展示"><a href="#调整列表页展示" class="header-anchor">#</a> 调整列表页展示</h3> <ul><li>调整列表页和编辑页必须先---定义与使用Admin管理类</li> <li>Django提供的Admin站点的展示效果可以通过自定义ModelAdmin类来进行控制</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>定义管理类需要继承自admin<span class="token punctuation">.</span>ModelAdmin类，如下

<span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin

<span class="token keyword">class</span> <span class="token class-name">BookInfoAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token keyword">pass</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>使用管理类有两种方式：
注册参数
admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>BookInfo<span class="token punctuation">,</span>BookInfoAdmin<span class="token punctuation">)</span>
装饰器
<span class="token decorator annotation punctuation">@admin<span class="token punctuation">.</span>register</span><span class="token punctuation">(</span>BookInfo<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">BookInfoAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token keyword">pass</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>列表中的列显示哪些字段</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>属性如下：
list_display<span class="token operator">=</span><span class="token punctuation">[</span>模型字段<span class="token number">1</span><span class="token punctuation">,</span>模型字段<span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
打开booktest<span class="token operator">/</span>admin<span class="token punctuation">.</span>py文件，修改BookInfoAdmin类如下：
<span class="token keyword">class</span> <span class="token class-name">BookInfoAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
list_display <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span><span class="token string">'btitle'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>页大小</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>每页中显示多少条数据，默认为每页显示<span class="token number">100</span>条数据，属性如下：
list_per_page<span class="token operator">=</span><span class="token number">100</span>
打开booktest<span class="token operator">/</span>admin<span class="token punctuation">.</span>py文件，修改AreaAdmin类如下：
<span class="token keyword">class</span> <span class="token class-name">BookInfoAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
list_per_page <span class="token operator">=</span> <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>&quot;操作选项&quot;的位置</li> <li>顶部显示的属性，设置为True在顶部显示，设置为False不在顶部显示，默认为True。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>actions_on_top<span class="token operator">=</span><span class="token boolean">True</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>底部显示的属性，设置为True在底部显示，设置为False不在底部显示，默认为False。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>actions_on_bottom<span class="token operator">=</span><span class="token boolean">False</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>打开booktest<span class="token operator">/</span>admin<span class="token punctuation">.</span>py文件，修改BookInfoAdmin类如下：

<span class="token keyword">class</span> <span class="token class-name">BookInfoAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    actions_on_top <span class="token operator">=</span> <span class="token boolean">True</span>
    actions_on_bottom <span class="token operator">=</span> <span class="token boolean">True</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>右侧栏过滤器</li> <li>属性如下，只能接收字段，会将对应字段的值列出来，用于快速过滤。一般用于有重复值的字段。</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>list_filter<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
打开booktest<span class="token operator">/</span>admin<span class="token punctuation">.</span>py文件，修改HeroInfoAdmin类如下：
<span class="token keyword">class</span> <span class="token class-name">HeroInfoAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    list_filter <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'hbook'</span><span class="token punctuation">,</span> <span class="token string">'hgender'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>搜索框</li> <li>属性如下，用于对指定字段的值进行搜索，支持模糊查询。列表类型，表示在这些字段上进行搜索。</li> <li>search_fields=[]</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>打开booktest<span class="token operator">/</span>admin<span class="token punctuation">.</span>py文件，修改HeroInfoAdmin类如下：
<span class="token keyword">class</span> <span class="token class-name">HeroInfoAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    search_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'hname'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>将方法作为列</li> <li>列可以是模型字段，还可以是模型方法，要求方法有返回值。</li> <li>通过设置short_description属性，可以设置在admin站点中显示的列名</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>打开booktest<span class="token operator">/</span>models<span class="token punctuation">.</span>py文件，修改BookInfo类如下：

<span class="token keyword">class</span> <span class="token class-name">BookInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">pub_date</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>bpub_date<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y年%m月%d日'</span><span class="token punctuation">)</span>

    pub_date<span class="token punctuation">.</span>short_description <span class="token operator">=</span> <span class="token string">'发布日期'</span>  <span class="token comment"># 设置方法字段在admin中显示的标题</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>打开booktest<span class="token operator">/</span>admin<span class="token punctuation">.</span>py文件，修改BookInfoAdmin类如下：

<span class="token keyword">class</span> <span class="token class-name">BookInfoAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    list_display <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span><span class="token string">'atitle'</span><span class="token punctuation">,</span><span class="token string">'pub_date'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>方法列是不能排序的，如果需要排序需要为方法指定排序依据。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>admin_order_field<span class="token operator">=</span>模型类字段
打开booktest<span class="token operator">/</span>models<span class="token punctuation">.</span>py文件，修改BookInfo类如下：
<span class="token keyword">class</span> <span class="token class-name">BookInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">pub_date</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>bpub_date<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y年%m月%d日'</span><span class="token punctuation">)</span>
    pub_date<span class="token punctuation">.</span>short_description <span class="token operator">=</span> <span class="token string">'发布日期'</span>
    pub_date<span class="token punctuation">.</span>admin_order_field <span class="token operator">=</span> <span class="token string">'bpub_date'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>关联对象</li> <li>无法直接访问关联对象的属性或方法，可以在模型类中封装方法，访问关联对象的成员</li></ul> <div class="language-python line-numbers-mode"><pre class="language-python"><code>打开booktest<span class="token operator">/</span>models<span class="token punctuation">.</span>py文件，修改HeroInfo类如下：

<span class="token keyword">class</span> <span class="token class-name">HeroInfo</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>hbook<span class="token punctuation">.</span>bread

    read<span class="token punctuation">.</span>short_description <span class="token operator">=</span> <span class="token string">'图书阅读量'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-python line-numbers-mode"><pre class="language-python"><code>打开booktest<span class="token operator">/</span>admin<span class="token punctuation">.</span>py文件，修改HeroInfoAdmin类如下：

<span class="token keyword">class</span> <span class="token class-name">HeroInfoAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    list_display <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'hname'</span><span class="token punctuation">,</span> <span class="token string">'hbook'</span><span class="token punctuation">,</span> <span class="token string">'read'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="调整编辑页展示"><a href="#调整编辑页展示" class="header-anchor">#</a> 调整编辑页展示</h3> <p>显示字段</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>属性如下：
fields=[]

打开booktest/admin.py文件，修改BookInfoAdmin类如下：
class BookInfoAdmin(admin.ModelAdmin):
    ...
    fields = ['btitle', 'bpub_date']
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>分组显示</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>属性如下：
fieldsets=(
    ('组1标题',{'fields':('字段1','字段2')}),
    ('组2标题',{'fields':('字段3','字段4')}),
)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>打开booktest/admin.py文件，修改BookInfoAdmin类如下：
class BookInfoAdmin(admin.ModelAdmin):
    ...
    # fields = ['btitle', 'bpub_date']
    fieldsets = (
        ('基本', {'fields': ['btitle', 'bpub_date']}),
        ('高级', {
            'fields': ['bread', 'bcomment'],
            'classes': ('collapse',)  # 是否折叠显示
        })
    )
说明：fields与fieldsets两者选一使用。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>关联对象</li> <li>在一对多的关系中，可以在一端的编辑页面中编辑多端的对象，嵌入多端对象的方式包括表格、块两种。
<ul><li>类型InlineModelAdmin：表示在模型的编辑页面嵌入关联模型的编辑。</li> <li>子类TabularInline：以表格的形式嵌入。</li> <li>子类StackedInline：以块的形式嵌入。</li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>打开booktest/admin.py文件，创建HeroInfoStackInline类。

class HeroInfoStackInline(admin.StackedInline):
    model = HeroInfo  # 要编辑的对象
    extra = 1  # 附加编辑的数量
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>打开booktest/admin.py文件，修改BookInfoAdmin类如下：

class BookInfoAdmin(admin.ModelAdmin):
    ...
    inlines = [HeroInfoStackInline]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以用表格的形式嵌入。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>打开booktest/admin.py文件，创建HeroInfoTabularInline类。

class HeroInfoTabularInline(admin.TabularInline):
    model = HeroInfo
    extra = 1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>打开booktest/admin.py文件，修改BookInfoAdmin类如下：

class BookInfoAdmin(admin.ModelAdmin):
    ...
    inlines = [HeroInfoTabularInline]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="上传图片"><a href="#上传图片" class="header-anchor">#</a> 上传图片</h3> <ul><li>Django有提供文件系统支持，在Admin站点中可以轻松上传图片。</li> <li>使用Admin站点保存图片，需要安装Python的图片操作包</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>pip install Pillow
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>配置
<ul><li>默认情况下，Django会将上传的图片保存在本地服务器上，需要配置保存的路径。</li> <li>我们可以将上传的文件保存在静态文件目录中，如我们之前设置的static_files目录中在settings.py 文件中添加如下上传保存目录信息</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>MEDIA_ROOT=os.path.join(BASE_DIR,&quot;static_files/media&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li>为模型类添加ImageField字段<div class="language- line-numbers-mode"><pre class="language-text"><code>我们为之前的BookInfo模型类添加一个ImageFiled

class BookInfo(models.Model):
    ...
    image = models.ImageField(upload_to='booktest', verbose_name='图片', null=True)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>upload_to 选项指明该字段的图片保存在MEDIA_ROOT目录中的哪个子目录
进行数据库迁移操作

python manage.py makemigrations
python manage.py migrate
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li>使用Admin站点上传图片
进入Admin站点的图书管理页面，选择一个图书，能发现多出来一个上传图片的字段</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.dd60fddf.js" defer></script><script src="/assets/js/2.1d799614.js" defer></script><script src="/assets/js/19.0925b886.js" defer></script>
  </body>
</html>
